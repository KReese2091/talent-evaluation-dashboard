<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talent Evaluation Dashboard - Working Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #A4DBE8 0%, #00AFD7 100%);
            color: #11224B;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            display: flex;
            min-height: 100vh;
            padding: 0;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #11224B;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 20px 0;
            z-index: 1000;
            box-shadow: 0 2px 12px rgba(17, 34, 75, 0.15);
            border-bottom: 3px solid #0073CE;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            height: 80px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0, 115, 206, 0.15));
            flex-shrink: 0;
        }

        .header-text {
            text-align: center;
            flex-grow: 0;
        }

        .header h1 {
            margin: 0;
            font-size: 36px;
            font-weight: 600;
            color: #11224B;
            line-height: 1.2;
            text-align: center;
        }

        .header p {
            margin: 8px 0 0 0;
            font-size: 18px;
            color: #666666;
            font-weight: 400;
            line-height: 1.3;
            text-align: center;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #11224B 0%, #112756 100%);
            padding: 120px 0 20px 0;
            box-shadow: 4px 0 12px rgba(17, 34, 75, 0.3);
            position: relative;
        }

        .progress-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 0 20px;
        }

        .step {
            width: 100%;
            text-align: left;
            padding: 16px 20px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .step:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .step.active {
            background: #0067A0;
            border-color: #00AFD7;
            box-shadow: 0 4px 12px rgba(0, 103, 160, 0.4);
        }

        .step.completed {
            background: #00358E;
            border-color: #0067A0;
        }

        .step.completed::after {
            content: "✓";
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #A4DBE8;
            font-weight: bold;
            font-size: 16px;
        }

        /* Evaluation Mode Sidebar Styles */
        .current-employee-info {
            padding: 0 15px 20px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .current-employee-info h4 {
            color: white;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .employee-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .employee-card .employee-name {
            color: white;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .employee-card .employee-position {
            color: #A4DBE8;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .employee-card .employee-status {
            font-size: 11px;
            font-weight: 500;
        }

        .progress-steps {
            padding: 20px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .progress-steps h4 {
            color: white;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .progress-steps .step {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .progress-steps .step:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .progress-steps .step.active {
            background: rgba(0, 175, 215, 0.3);
            border: 1px solid #00AFD7;
        }

        .progress-steps .step.completed {
            background: rgba(40, 167, 69, 0.3);
            border: 1px solid #28a745;
        }

        .step-number {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .progress-steps .step.active .step-number {
            background: #00AFD7;
        }

        .progress-steps .step.completed .step-number {
            background: #28a745;
        }

        .step-title {
            color: #A4DBE8;
            font-size: 11px;
            font-weight: 500;
        }

        .progress-steps .step.active .step-title {
            color: white;
        }

        .progress-steps .step.completed .step-title {
            color: #90ee90;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 120px 40px 20px 40px;
            background: linear-gradient(135deg, #A4DBE8 0%, #00AFD7 100%);
            overflow-y: auto;
        }

        /* Progress Indicator */
        .progress-indicator {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px 25px;
            margin: 0 -25px 0 -25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: none; /* Hidden by default, shown in evaluation mode */
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-title {
            font-size: 14px;
            font-weight: 600;
            color: #11224B;
        }

        .progress-percentage {
            font-size: 16px;
            font-weight: 700;
            color: #0067A0;
        }

        .progress-bar-container {
            background: rgba(0, 0, 0, 0.1);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00AFD7 0%, #0067A0 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-current-step {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        /* Horizontal Step Navigation */
        .horizontal-step-nav {
            background: linear-gradient(90deg, #11224B 0%, #112756 100%);
            padding: 12px 0;
            margin: 0 -25px 20px -25px;
            border-radius: 0;
            box-shadow: 0 2px 8px rgba(17, 34, 75, 0.2);
        }

        .step-navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .step-navigation .step {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
        }

        .step-navigation .step:hover {
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .step-navigation .step.active {
            background: #0067A0;
            border-color: #00AFD7;
            box-shadow: 0 4px 12px rgba(0, 103, 160, 0.4);
        }

        .step-navigation .step.completed {
            background: #00AFD7;
            color: #11224B;
        }

        .step-navigation .step.completed::after {
            content: "✓";
            position: absolute;
            bottom: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #00AFD7;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Content Area */
        .content-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 24px rgba(17, 34, 75, 0.15);
            margin: 0 auto 20px auto;
            min-height: calc(100vh - 200px);
            max-width: 800px;
        }

        .slide {
            display: none;
        }

        .slide.active {
            display: block;
        }

        h2 {
            color: #11224B;
            margin-bottom: 10px;
            font-size: 22px;
        }

        .description {
            color: #666;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.4;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #11224B;
            font-size: 13px;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #0067A0;
        }

        input[readonly] {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #e9ecef;
        }

        /* Rating Buttons */
        .rating-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .rating-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            min-width: 120px;
        }

        .rating-btn:hover {
            border-color: #0067A0;
            transform: translateY(-1px);
        }

        .rating-btn.selected {
            border-color: #0067A0;
            background: #f0f8ff;
        }

        .rating-btn strong {
            display: block;
            color: #11224B;
            margin-bottom: 3px;
            font-size: 13px;
        }

        .rating-btn small {
            color: #666;
            font-size: 11px;
        }

        /* Smart Suggestions */
        .suggestions {
            background: #f0f8ff;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .suggestions h4 {
            margin-bottom: 6px;
            color: #0067A0;
            font-size: 14px;
        }

        .suggestion-item {
            background: white;
            padding: 8px;
            margin: 6px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            border: 1px solid #ddd;
            transition: all 0.2s;
        }

        .suggestion-item:hover {
            background: #0067A0;
            color: white;
            transform: translateX(5px);
        }

        /* Navigation */
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(17, 34, 75, 0.1);
            margin-top: 15px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #0067A0;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #00358E;
        }

        .btn-primary.step-ready {
            background: #00AFD7 !important;
            box-shadow: 0 2px 8px rgba(0, 175, 215, 0.3);
            transition: all 0.3s ease;
        }

        .btn-primary.step-ready:hover {
            background: #0096b8 !important;
            transform: scale(1.05);
        }

        .btn-outline {
            background: transparent;
            color: #0067A0;
            border: 2px solid #0067A0;
        }

        .btn-outline:hover {
            background: #0067A0;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: 2px solid #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
            border-color: #5a6268;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .step-info {
            font-weight: 500;
            color: #11224B;
        }







        .help-content li {
            margin-bottom: 10px;
            line-height: 1.5;
            color: #333;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 120px 0 20px 0;
            }
            
            .progress-steps {
                flex-direction: row;
                overflow-x: auto;
                gap: 10px;
                padding: 0 20px;
            }
            
            .step {
                min-width: 150px;
                text-align: center;
                padding: 12px 16px;
                font-size: 12px;
            }
            
            .main-content {
                padding: 120px 20px 20px 20px;
            }
            
            .step-navigation {
                gap: 15px;
                padding: 0 15px;
            }
            
            .step-navigation .step {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
            
            .header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: white;
                border-bottom: 2px solid #0073CE;
            }
            
            .header-content {
                flex-direction: column;
                gap: 20px;
                padding: 0 15px;
            }
            
            .logo {
                height: 60px;
            }
            
            .header h1 {
                font-size: 28px;
            }
            
            .header p {
                font-size: 16px;
            }
            
            .header-text {
                text-align: center;
            }
            
            .content-card {
                min-height: auto;
            }
        }

        @media (max-width: 768px) {
            .step-navigation {
                gap: 10px;
                padding: 0 10px;
                overflow-x: auto;
            }
            
            .step-navigation .step {
                width: 40px;
                height: 40px;
                font-size: 14px;
                flex-shrink: 0;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .rating-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .rating-btn {
                min-width: auto;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
                gap: 6px;
            }
            
            .content-card {
                max-width: none;
                margin: 0 0 20px 0;
            }
        }

        /* Reviewer Dashboard Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #A4DBE8 0%, #00AFD7 100%);
        }

        .login-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 8px 24px rgba(17, 34, 75, 0.15);
            max-width: 500px;
            width: 100%;
        }

        .login-card h2 {
            margin-bottom: 10px;
            color: #11224B;
            text-align: center;
        }

        .login-card p {
            margin-bottom: 30px;
            color: #666;
            text-align: center;
        }

        .demo-reviewers {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .demo-reviewers h4 {
            margin-bottom: 15px;
            color: #11224B;
        }

        .demo-reviewers .btn {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            text-align: left;
        }

        .quick-guide {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .quick-guide h4 {
            margin-bottom: 15px;
            color: #11224B;
            font-size: 16px;
        }

        .guide-steps {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .guide-step {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #11224B;
            border-left: 3px solid #00AFD7;
        }

        .guide-note {
            font-size: 12px;
            color: #666;
            margin: 0;
            text-align: center;
            padding: 10px;
            background: #f0f8ff;
            border-radius: 4px;
        }

        .reviewer-info {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .reviewer-info h3 {
            margin: 0;
            color: white;
            font-size: 18px;
        }

        .reviewer-info p {
            margin: 5px 0 15px 0;
            color: #A4DBE8;
            font-size: 14px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        .employee-list {
            margin-bottom: 30px;
        }

        .employee-list h4 {
            color: white;
            margin-bottom: 15px;
            padding: 0 20px;
        }

        /* Search Styles */
        .search-section {
            padding: 0 20px;
            margin-bottom: 15px;
        }

        .search-container {
            position: relative;
            margin-bottom: 12px;
        }

        .employee-search {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .employee-search::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .employee-search:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            border-color: #00AFD7;
            box-shadow: 0 0 0 2px rgba(0, 175, 215, 0.3);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        .clear-search {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .clear-search:hover {
            background: rgba(255, 255, 255, 0.3);
        }



        .employee-dropdown {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .employee-dropdown:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .employee-dropdown:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.25);
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
        }

        .employee-dropdown option {
            background: #2c3e50;
            color: white;
            padding: 8px;
        }

        .employee-actions-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .selected-employee-info {
            color: white;
            margin-bottom: 12px;
            font-weight: 500;
            font-size: 14px;
        }

        .smart-actions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .smart-action-item {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 13px;
        }

        .smart-action-item:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateX(2px);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .action-buttons .btn {
            font-size: 12px;
            padding: 8px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            white-space: nowrap;
        }

        .action-buttons .btn-primary {
            background: #007bff;
            color: white;
            grid-column: 1 / -1; /* Span full width */
        }

        .action-buttons .btn-primary:hover {
            background: #0056b3;
        }

        .action-buttons .btn-download {
            background: #28a745;
            color: white;
        }

        .action-buttons .btn-download:hover:not(:disabled) {
            background: #1e7e34;
        }

        .action-buttons .btn-download:disabled {
            background: #6c757d;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-buttons .btn-archive {
            background: #6c757d;
            color: white;
        }

        .action-buttons .btn-archive:hover {
            background: #5a6268;
        }

        .action-buttons .btn-delete {
            background: #dc3545;
            color: white;
        }

        .action-buttons .btn-delete:hover {
            background: #c82333;
        }

        .employee-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.2) !important;
            border-radius: 4px;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .employee-content {
            flex: 1;
            cursor: pointer;
        }

        .employee-item:hover {
            background: rgba(255, 255, 255, 0.35) !important;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .employee-actions {
            display: flex;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .employee-item:hover .employee-actions {
            opacity: 1;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-left: 4px;
        }

        .btn-delete:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .btn-archive {
            background: #6c757d;
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-right: 3px;
        }

        .btn-archive:hover {
            background: #5a6268;
            transform: scale(1.1);
        }

        .btn-restore {
            background: #28a745;
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-right: 3px;
        }

        .btn-restore:hover {
            background: #218838;
            transform: scale(1.1);
        }

        .btn-download {
            background: #0073CE;
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-right: 3px;
        }

        .btn-download:hover:not(.disabled) {
            background: #005a9d;
            transform: scale(1.1);
        }

        .btn-download.disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-download.disabled:hover {
            transform: none;
        }

        .archived-employees {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .archived-toggle {
            cursor: pointer;
            color: #ccc;
            font-size: 14px;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .archived-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .employee-item.archived {
            opacity: 0.7;
            border-left-color: #6c757d;
        }

        .archived-status {
            color: #6c757d;
            font-size: 12px;
        }

        .employee-item.completed {
            border-left-color: #28a745;
        }

        .employee-item.in-progress {
            border-left-color: #ffc107;
        }

        .employee-item.not-started {
            border-left-color: #6c757d;
        }

        .employee-name {
            color: #ffffff !important;
            font-weight: 700 !important;
            font-size: 14px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5) !important;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .employee-position {
            color: #ffffff !important;
            font-size: 12px;
            margin: 1px 0;
            opacity: 0.85 !important;
            font-weight: 500 !important;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .employee-status {
            font-size: 12px;
            font-weight: 500;
            margin-top: 5px;
        }

        .status-completed {
            color: #28a745 !important;
            font-weight: 400 !important;
        }

        .status-in-progress {
            color: #ffc107 !important;
            font-weight: 400 !important;
        }

        .status-not-started {
            color: #6c757d !important;
            font-weight: 400 !important;
        }

        /* Drag and Drop Styles */
        .employee-item[draggable="true"] {
            cursor: move;
        }

        .employee-item.drag-over {
            border: 2px dashed #00AFD7 !important;
            background: rgba(0, 175, 215, 0.1) !important;
            transform: scale(1.02);
        }

        .employee-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .drag-handle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-right: 8px;
            cursor: move;
            transition: color 0.2s ease;
        }

        .employee-item:hover .drag-handle {
            color: rgba(255, 255, 255, 0.9);
        }

        .sort-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            padding: 0 15px;
        }

        .sort-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sort-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .sort-btn.active {
            background: #00AFD7;
            border-color: #0067A0;
        }

        .btn-add-employee {
            width: 100%;
            margin: 15px 20px 0 20px;
            width: calc(100% - 40px);
        }

        /* Undo/Redo Notification */
        .undo-redo-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: rgba(33, 37, 41, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .undo-redo-notification.show {
            transform: translateX(-50%) translateY(0);
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .notification-icon {
            font-size: 16px;
            opacity: 0.9;
        }

        .notification-text {
            white-space: nowrap;
        }

        /* Undo/Redo Button Styles (for future use) */
        .undo-redo-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            margin: 0 2px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .undo-redo-btn:hover:not(:disabled) {
            background: #5a6268;
        }

        .undo-redo-btn:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }

        .undo-redo-btn:focus {
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
        }

        /* Shortcuts Info Panel */
        .shortcuts-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .shortcuts-info h5 {
            color: white;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .shortcut-item kbd {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-width: 80px;
            text-align: center;
        }

        .shortcut-item span {
            color: rgba(255, 255, 255, 0.8);
        }

        .shortcut-note {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 8px;
            font-style: italic;
            line-height: 1.3;
        }

        .team-summary {
            padding: 0 15px;
        }

        .team-summary h4 {
            color: white;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .summary-stats {
            display: flex;
            gap: 8px;
            justify-content: space-around;
        }

        .stat {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px;
            border-radius: 4px;
            flex: 1;
        }

        .stat-number {
            display: block;
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        .stat-label {
            color: #A4DBE8;
            font-size: 10px;
        }

        .summary-actions-simple {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .summary-textarea {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
        }

        .dashboard-welcome {
            text-align: center;
        }

        .quick-actions {
            margin: 40px 0;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .recent-activity {
            text-align: left;
            max-width: 600px;
            margin: 0 auto;
        }

        .activity-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }

        .activity-item {
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-main {
            flex: 1;
            min-width: 0;
        }

        .activity-name {
            font-weight: 600;
            color: #11224B;
            font-size: 15px;
            line-height: 1.3;
            margin-bottom: 2px;
        }

        .activity-action {
            color: #666;
            font-size: 14px;
            line-height: 1.3;
        }

        .activity-date {
            color: #666;
            font-size: 13px;
            white-space: nowrap;
            flex-shrink: 0;
            text-align: right;
            font-weight: 500;
        }

        .evaluation-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .btn-back {
            flex-shrink: 0;
        }

        .employee-info {
            flex-grow: 1;
        }

        .employee-info h2 {
            margin: 0;
            color: #11224B;
            font-size: 18px;
        }

        .employee-info p {
            margin: 5px 0 0 0;
            color: #666;
        }

        .employee-status-line {
            font-weight: 400 !important;
            font-size: 12px;
        }

        .employee-status-line span {
            font-weight: 400 !important;
        }

        .progress-indicator {
            margin-bottom: 20px;
        }

        .progress-indicator .progress-steps {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .progress-indicator .step {
            background: #e9ecef;
            color: #6c757d;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
        }

        .progress-indicator .step.active {
            background: #0067A0;
            color: white;
        }

        .progress-indicator .step.completed {
            background: #28a745;
            color: white;
        }

        /* Status Change Notification */
        .status-notification {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1001;
            animation: slideInRight 0.3s ease-out;
        }

        .notification-content {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 350px;
        }

        .notification-icon {
            font-size: 16px;
            flex-shrink: 0;
        }

        .notification-text {
            color: #856404;
            font-size: 14px;
            font-weight: 500;
            flex: 1;
        }

        .notification-close {
            background: none;
            border: none;
            color: #856404;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .notification-close:hover {
            background-color: rgba(133, 100, 4, 0.1);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* AI Writing Coach */
        .writing-coach {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border: 1px solid #0067A0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .coach-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .coach-header h4 {
            color: #0067A0;
            margin: 0;
            margin-left: 8px;
            font-size: 14px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 8px;
            margin-bottom: 10px;
        }

        .metric {
            text-align: center;
            padding: 6px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .metric.good {
            border-color: #28a745;
        }

        .metric.warning {
            border-color: #ffc107;
        }

        .metric.poor {
            border-color: #dc3545;
        }

        .metric-value {
            font-size: 16px;
            font-weight: bold;
            display: block;
        }

        .metric.good .metric-value {
            color: #28a745;
        }

        .metric.warning .metric-value {
            color: #ffc107;
        }

        .metric.poor .metric-value {
            color: #dc3545;
        }

        .metric-label {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }

        .bias-alerts {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 6px;
            margin-top: 8px;
        }

        .bias-alert {
            color: #856404;
            font-size: 11px;
            margin: 3px 0;
        }

        .bias-alert strong {
            color: #dc3545;
        }

        /* Carousel Slide Styles */
        .slide {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            padding: 0;
        }

        .slide.active {
            display: block;
            opacity: 1;
        }

        /* Analytics & Insights Styles */
        .analytics-container {
            display: grid;
            gap: 20px;
            padding: 20px;
        }

        .insights-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .insights-section h3 {
            margin: 0 0 15px 0;
            color: #11224B;
            font-size: 18px;
            border-bottom: 2px solid #00AFD7;
            padding-bottom: 8px;
        }

        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .pattern-card {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            border-left: 4px solid #00AFD7;
        }

        .pattern-card.warning {
            border-left-color: #ffc107;
            background: #fff9e6;
        }

        .pattern-card.alert {
            border-left-color: #dc3545;
            background: #ffeaea;
        }

        .pattern-title {
            font-weight: 600;
            color: #11224B;
            margin-bottom: 8px;
        }

        .pattern-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .pattern-data {
            font-size: 13px;
            color: #444;
        }

        .insight-metric {
            display: inline-block;
            background: #e3f2fd;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
            font-weight: 500;
        }

        .rating-distribution {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .rating-bar {
            flex: 1;
            text-align: center;
        }

        .rating-bar-fill {
            height: 40px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .rating-bar-fill.exemplary { background: #28a745; }
        .rating-bar-fill.successful { background: #00AFD7; }
        .rating-bar-fill.opportunity { background: #ffc107; color: #333; }

        .bias-heatmap {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .bias-indicator {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .bias-indicator.high {
            border-color: #dc3545;
            background: #ffeaea;
        }

        .bias-indicator.medium {
            border-color: #ffc107;
            background: #fff9e6;
        }

        .bias-indicator.low {
            border-color: #28a745;
            background: #eafaf1;
        }

        .trend-chart {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .recommendations-list {
            list-style: none;
            padding: 0;
        }

        .recommendations-list li {
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .recommendation-icon {
            background: #00AFD7;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-top: 2px;
        }

        /* Team Report Modal Styles */
        .team-report-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(17, 34, 75, 0.8);
            z-index: 2000;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            padding-top: 5vh;
            overflow-y: auto;
        }

        .team-report-modal {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(17, 34, 75, 0.3);
            max-width: 900px;
            width: 100%;
            max-height: none;
            overflow-y: visible;
            position: relative;
            margin-bottom: 5vh;
        }

        .report-header {
            background: linear-gradient(135deg, #11224B 0%, #112756 100%);
            color: white;
            padding: 30px;
            border-radius: 12px 12px 0 0;
            position: relative;
        }

        .report-header h2 {
            margin: 0 0 8px 0;
            font-size: 28px;
            font-weight: 600;
        }

        .report-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            background: none;
            border: none;
            color: white;
            font-size: 30px;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .close-btn:hover {
            opacity: 1;
        }

        .report-content {
            padding: 30px;
        }

        .report-section {
            margin-bottom: 35px;
        }

        .report-section h3 {
            color: #11224B;
            font-size: 22px;
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 2px solid #0073CE;
            padding-bottom: 8px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 10px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 25px 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            border-color: #0073CE;
            box-shadow: 0 4px 12px rgba(0, 115, 206, 0.15);
        }

        .metric-number {
            font-size: 36px;
            font-weight: bold;
            color: #11224B;
            line-height: 1;
            margin-bottom: 8px;
        }

        .metric-label {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .rating-distribution {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
        }

        .rating-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .rating-bar:last-child {
            margin-bottom: 0;
        }

        .rating-label {
            width: 100px;
            font-weight: 600;
            color: #11224B;
            font-size: 14px;
        }

        .rating-progress {
            flex: 1;
            background: #e9ecef;
            border-radius: 20px;
            height: 24px;
            position: relative;
            overflow: hidden;
        }

        .rating-fill {
            height: 100%;
            border-radius: 20px;
            transition: width 0.6s ease;
        }

        .rating-fill.exemplary {
            background: linear-gradient(90deg, #28a745, #34ce57);
        }

        .rating-fill.successful {
            background: linear-gradient(90deg, #0073CE, #1e88e5);
        }

        .rating-fill.opportunity {
            background: linear-gradient(90deg, #ffc107, #ffeb3b);
        }

        .rating-fill.not-rated {
            background: linear-gradient(90deg, #6c757d, #8d9297);
        }

        .rating-count {
            width: 30px;
            text-align: center;
            font-weight: bold;
            color: #11224B;
            font-size: 16px;
        }

        .employee-status-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .employee-status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .employee-status-item:last-child {
            border-bottom: none;
        }

        .employee-info {
            flex: 1;
        }

        .employee-name {
            font-weight: 600;
            color: #333333 !important;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .team-report-modal .employee-name {
            color: #333333 !important;
            font-weight: 600;
        }

        .employee-status-list .employee-name {
            color: #333333 !important;
            font-weight: 600;
        }

        .employee-position {
            color: #495057 !important;
            font-size: 14px;
            font-weight: 500;
        }

        .team-report-modal .employee-position {
            color: #495057 !important;
        }

        .status-info {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.completed {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.in-progress {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.not-started {
            background: #f8d7da;
            color: #721c24;
        }

        .rating-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 400;
            text-transform: capitalize;
        }

        .rating-badge.exemplary {
            background: #d4edda;
            color: #155724;
        }

        .rating-badge.successful {
            background: #cce7ff;
            color: #004085;
        }

        .rating-badge.opportunity {
            background: #fff3cd;
            color: #856404;
        }

        .rating-badge.not-set {
            background: #e9ecef;
            color: #6c757d;
        }

        .report-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .team-report-modal {
                margin: 10px;
                max-height: 95vh;
            }

            .report-header {
                padding: 20px;
            }

            .report-content {
                padding: 20px;
            }

            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 15px;
            }

            .employee-status-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .status-info {
                align-self: stretch;
                justify-content: flex-end;
            }

            .report-actions {
                flex-direction: column;
                align-items: stretch;
            }


        }

        /* Hide Navigation Buttons to Clean Up Interface */
        .navigation {
            display: none !important;
        }

        /* Step Progress Notifications for Backend Navigation */
        .step-progress-notification {
            position: fixed;
            top: 100px;
            right: 30px;
            background: linear-gradient(135deg, #0073CE, #00AFD7);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 115, 206, 0.3);
            z-index: 1500;
            animation: slideInRight 0.5s ease, slideOutRight 0.5s ease 2.5s forwards;
            min-width: 250px;
        }

        .progress-notification-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-icon {
            font-size: 20px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-text {
            flex: 1;
        }

        .progress-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .progress-subtitle {
            font-size: 12px;
            opacity: 0.9;
            line-height: 1.3;
        }

        @keyframes slideInRight {
            from { 
                transform: translateX(100%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from { 
                transform: translateX(0);
                opacity: 1;
            }
            to { 
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .step-progress-notification {
                right: 15px;
                left: 15px;
                min-width: auto;
                top: 90px;
            }
        }

        /* Hide Sidebar Step Navigation Buttons Only */
        .sidebar .progress-steps {
            display: none !important;
        }
        
        .sidebar .step {
            display: none !important;
        }

        /* Ensure Navigation Buttons Are Visible */
        .navigation {
            display: flex !important;
        }

        #prevBtn, #nextBtn, .step-info, #stepInfo {
            display: block !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <!-- Sam's Club Logo -->
            <img src="sams-club-logo.png" alt="Sam's Club" class="logo">
            
            <div class="header-text">
                <h1>Talent Evaluation Dashboard</h1>
                <p>Step-by-step performance evaluation process</p>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Sidebar (hidden in evaluation mode, shown in reviewer dashboard) -->
        <div class="sidebar" id="mainSidebar" style="display: none;">
        </div>

        <!-- Main Content Area -->
        <div class="main-content" id="mainContent">
            <!-- Progress Indicator (only shown in evaluation mode) -->
            <div class="progress-indicator" id="progressIndicator">
                <div class="progress-header">
                    <div class="progress-title">Evaluation Progress</div>
                    <div class="progress-percentage" id="progressPercentage">0%</div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBarFill"></div>
                </div>
                <div class="progress-current-step" id="progressCurrentStep">Step 1 of 7: Basic Information & Overall Rating</div>
            </div>
            <!-- Horizontal Step Navigation (only shown in evaluation mode) -->
            <div class="horizontal-step-nav" id="stepNavigation">
                <div class="step-navigation">
                    <div class="step active" onclick="goToStep(0)" title="Basic Information & Rating">1</div>
                    <div class="step" onclick="goToStep(1)" title="Key Priorities">2</div>
                    <div class="step" onclick="goToStep(2)" title="Results & Impact">3</div>
                    <div class="step" onclick="goToStep(3)" title="Collaboration & Influence">4</div>
                    <div class="step" onclick="goToStep(4)" title="Growth & Development">5</div>
                    <div class="step" onclick="goToStep(5)" title="Looking Ahead">6</div>
                    <div class="step" onclick="goToStep(6)" title="Comprehensive Summary">7</div>
                </div>
            </div>
            <!-- Content Card -->
            <div class="content-card">
            <!-- Step 0: Basic Information -->
            <div class="slide active" id="slide-0">
                <h2>Basic Information & Overall Rating</h2>
                <p class="description">Enter basic information and select the overall performance rating</p>

                <div class="form-row">
                    <div class="form-group">
                        <label for="employeeName">Employee Name:</label>
                        <input type="text" id="employeeName" placeholder="Enter employee name">
                    </div>
                    <div class="form-group">
                        <label for="reviewerName">Reviewer Name:</label>
                        <input type="text" id="reviewerName" placeholder="Enter reviewer name">
                    </div>
                </div>

                <div class="form-group">
                    <label for="reviewPeriod">Fiscal Year:</label>
                    <select id="reviewPeriod">
                        <option value="FY26">FY26</option>
                        <option value="FY25">FY25</option>
                        <option value="FY24">FY24</option>
                        <option value="FY23">FY23</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Overall Performance Rating:</label>
                    <div class="rating-buttons">
                        <div class="rating-btn" onclick="selectRating(this, 'exemplary')">
                            <strong>Exemplary</strong>
                            <small>Performance consistently exceeds the requirements of the role</small>
                        </div>
                        <div class="rating-btn selected" onclick="selectRating(this, 'successful')">
                            <strong>Successful</strong>
                            <small>Performance consistently meets the requirements of the role</small>
                        </div>
                        <div class="rating-btn" onclick="selectRating(this, 'opportunity')">
                            <strong>Opportunity</strong>
                            <small>Performance consistently failed to meet the requirements of the role</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 1: Key Priorities -->
            <div class="slide" id="slide-1">
                <h2>Key Priorities</h2>
                <p class="description">What were the associate's main goals or deliverables this year?</p>

                <div class="suggestions">
                    <h4>Smart Content Suggestions</h4>
                    <div class="suggestion-item" onclick="addSuggestion('keyPriorities', 'Successfully delivered on key business priorities including...')">
                        "Successfully delivered on key business priorities including..."
                    </div>
                    <div class="suggestion-item" onclick="addSuggestion('keyPriorities', 'Exceeded expectations by achieving...')">
                        "Exceeded expectations by achieving..."
                    </div>
                    <div class="suggestion-item" onclick="addSuggestion('keyPriorities', 'Consistently focused on strategic objectives such as...')">
                        "Consistently focused on strategic objectives such as..."
                    </div>
                </div>

                <div class="form-group">
                    <label for="keyPriorities">Feedback:</label>
                    <textarea id="keyPriorities" rows="6" placeholder="Provide specific, objective feedback with examples and measurable outcomes..." onkeyup="analyzeFeedback('keyPriorities')"></textarea>
                </div>

                <!-- AI Writing Coach -->
                <div class="writing-coach" id="coach-keyPriorities" style="display: none;">
                    <div class="coach-header">
                        <span style="font-size: 20px;">🤖</span>
                        <h4>AI Writing Coach</h4>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric" id="objectivity-keyPriorities">
                            <span class="metric-value">0%</span>
                            <div class="metric-label">Objectivity</div>
                        </div>
                        <div class="metric" id="specificity-keyPriorities">
                            <span class="metric-value">0%</span>
                            <div class="metric-label">Specificity</div>
                        </div>
                        <div class="metric" id="completeness-keyPriorities">
                            <span class="metric-value">0%</span>
                            <div class="metric-label">Completeness</div>
                        </div>
                    </div>
                    <div class="bias-alerts" id="alerts-keyPriorities"></div>
                </div>
            </div>

            <!-- Step 2: Results & Impact -->
            <div class="slide" id="slide-2">
                <h2>Results & Impact</h2>
                <p class="description">What outcomes did they drive, and how did they move the business or brand forward?</p>

                <div class="suggestions">
                    <h4>Smart Content Suggestions</h4>
                    <div class="suggestion-item" onclick="addSuggestion('resultsImpact', 'Delivered measurable business impact by achieving...')">
                        "Delivered measurable business impact by achieving..."
                    </div>
                    <div class="suggestion-item" onclick="addSuggestion('resultsImpact', 'Generated significant value through...')">
                        "Generated significant value through..."
                    </div>
                    <div class="suggestion-item" onclick="addSuggestion('resultsImpact', 'Improved key metrics including...')">
                        "Improved key metrics including..."
                    </div>
                </div>

                <div class="form-group">
                    <label for="resultsImpact">Feedback:</label>
                    <textarea id="resultsImpact" rows="6" placeholder="Provide specific, objective feedback with examples and measurable outcomes..." onkeyup="analyzeFeedback('resultsImpact')"></textarea>
                </div>

                <!-- AI Writing Coach -->
                <div class="writing-coach" id="coach-resultsImpact" style="display: none;">
                    <div class="coach-header">
                        <span style="font-size: 20px;">🤖</span>
                        <h4>AI Writing Coach</h4>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric" id="objectivity-resultsImpact">
                            <span class="metric-value">0%</span>
                            <div class="metric-label">Objectivity</div>
                        </div>
                        <div class="metric" id="specificity-resultsImpact">
                            <span class="metric-value">0%</span>
                            <div class="metric-label">Specificity</div>
                        </div>
                        <div class="metric" id="completeness-resultsImpact">
                            <span class="metric-value">0%</span>
                            <div class="metric-label">Completeness</div>
                        </div>
                    </div>
                    <div class="bias-alerts" id="alerts-resultsImpact"></div>
                </div>
            </div>

            <!-- Step 3: Collaboration -->
            <div class="slide" id="slide-3">
                <h2>Collaboration & Influence</h2>
                <p class="description">How did they partner across teams or functions to deliver results?</p>

                <div class="suggestions">
                    <h4>Smart Content Suggestions</h4>
                    <div class="suggestion-item" onclick="addSuggestion('collaboration', 'Built strong partnerships with cross-functional teams to...')">
                        "Built strong partnerships with cross-functional teams to..."
                    </div>
                    <div class="suggestion-item" onclick="addSuggestion('collaboration', 'Influenced positive outcomes by effectively communicating...')">
                        "Influenced positive outcomes by effectively communicating..."
                    </div>
                    <div class="suggestion-item" onclick="addSuggestion('collaboration', 'Demonstrated leadership by facilitating...')">
                        "Demonstrated leadership by facilitating..."
                    </div>
                </div>

                <div class="form-group">
                    <label for="collaboration">Feedback:</label>
                    <textarea id="collaboration" rows="6" placeholder="Provide specific, objective feedback with examples and measurable outcomes..." onkeyup="analyzeFeedback('collaboration')"></textarea>
                </div>

                <!-- AI Writing Coach -->
                <div class="writing-coach" id="coach-collaboration" style="display: none;">
                    <div class="coach-header">
                        <span style="font-size: 20px;">🤖</span>
                        <h4>AI Writing Coach</h4>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric" id="objectivity-collaboration">
                            <span class="metric-value">0%</span>
                            <div class="metric-label">Objectivity</div>
                        </div>
                        <div class="metric" id="specificity-collaboration">
                            <span class="metric-value">0%</span>
                            <div class="metric-label">Specificity</div>
                        </div>
                        <div class="metric" id="completeness-collaboration">
                            <span class="metric-value">0%</span>
                            <div class="metric-label">Completeness</div>
                        </div>
                    </div>
                    <div class="bias-alerts" id="alerts-collaboration"></div>
                </div>
            </div>

            <!-- Step 4: Growth & Development -->
            <div class="slide" id="slide-4">
                <h2>Growth & Development</h2>
                <p class="description">What new skills, behaviors, or leadership qualities did they build this year?</p>

                <div class="suggestions">
                    <h4>Smart Content Suggestions</h4>
                    <div class="suggestion-item" onclick="addSuggestion('growth', 'Developed new capabilities in...')">
                        "Developed new capabilities in..."
                    </div>
                    <div class="suggestion-item" onclick="addSuggestion('growth', 'Showed significant growth by learning...')">
                        "Showed significant growth by learning..."
                    </div>
                    <div class="suggestion-item" onclick="addSuggestion('growth', 'Strengthened leadership skills through...')">
                        "Strengthened leadership skills through..."
                    </div>
                </div>

                <div class="form-group">
                    <label for="growth">Feedback:</label>
                    <textarea id="growth" rows="6" placeholder="Provide specific, objective feedback with examples and measurable outcomes..." onkeyup="analyzeFeedback('growth')"></textarea>
                </div>

                <!-- AI Writing Coach -->
                <div class="writing-coach" id="coach-growth" style="display: none;">
                    <div class="coach-header">
                        <span style="font-size: 20px;">🤖</span>
                        <h4>AI Writing Coach</h4>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric" id="objectivity-growth">
                            <span class="metric-value">0%</span>
                            <div class="metric-label">Objectivity</div>
                        </div>
                        <div class="metric" id="specificity-growth">
                            <span class="metric-value">0%</span>
                            <div class="metric-label">Specificity</div>
                        </div>
                        <div class="metric" id="completeness-growth">
                            <span class="metric-value">0%</span>
                            <div class="metric-label">Completeness</div>
                        </div>
                    </div>
                    <div class="bias-alerts" id="alerts-growth"></div>
                </div>
            </div>

            <!-- Step 5: Looking Ahead -->
            <div class="slide" id="slide-5">
                <h2>Looking Ahead</h2>
                <p class="description">What are their biggest opportunities and development areas to grow next year?</p>

                <div class="suggestions">
                    <h4>Smart Content Suggestions</h4>
                    <div class="suggestion-item" onclick="addSuggestion('lookingAhead', 'Key development opportunities include...')">
                        "Key development opportunities include..."
                    </div>
                    <div class="suggestion-item" onclick="addSuggestion('lookingAhead', 'Focus areas for next year should be...')">
                        "Focus areas for next year should be..."
                    </div>
                    <div class="suggestion-item" onclick="addSuggestion('lookingAhead', 'Recommended stretch assignments or experiences...')">
                        "Recommended stretch assignments or experiences..."
                    </div>
                </div>

                <div class="form-group">
                    <label for="lookingAhead">Feedback:</label>
                    <textarea id="lookingAhead" rows="6" placeholder="Provide specific, objective feedback with examples and measurable outcomes..." onkeyup="analyzeFeedback('lookingAhead')"></textarea>
                </div>

                <!-- AI Writing Coach -->
                <div class="writing-coach" id="coach-lookingAhead" style="display: none;">
                    <div class="coach-header">
                        <span style="font-size: 20px;">🤖</span>
                        <h4>AI Writing Coach</h4>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric" id="objectivity-lookingAhead">
                            <span class="metric-value">0%</span>
                            <div class="metric-label">Objectivity</div>
                        </div>
                        <div class="metric" id="specificity-lookingAhead">
                            <span class="metric-value">0%</span>
                            <div class="metric-label">Specificity</div>
                        </div>
                        <div class="metric" id="completeness-lookingAhead">
                            <span class="metric-value">0%</span>
                            <div class="metric-label">Completeness</div>
                        </div>
                    </div>
                    <div class="bias-alerts" id="alerts-lookingAhead"></div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="navigation">
                <button class="btn btn-outline" id="prevBtn" onclick="previousStep()" disabled>Previous</button>
                <div class="step-info" id="stepInfo">Step 1 of 6</div>
                <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">Next</button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        const totalSteps = 7;
        let currentReviewer = null;
        let currentEmployee = null;
        let reviewerData = {};
        let autoAdvancementInProgress = false;

        // Initialize reviewer system
        function initializeReviewerSystem() {
            // Load reviewer data from localStorage
            const savedData = localStorage.getItem('talentEvaluationData');
            if (savedData) {
                reviewerData = JSON.parse(savedData);
            }

            // Check if reviewer is logged in
            const urlParams = new URLSearchParams(window.location.search);
            const reviewerId = urlParams.get('reviewer');
            
            if (reviewerId) {
                currentReviewer = reviewerId;
                loadReviewerDashboard();
            } else {
                showReviewerLogin();
            }
        }

        function showReviewerLogin() {
            document.querySelector('.container').innerHTML = `
                <div class="login-container">
                    <div class="login-card">
                        <h2>Reviewer Access</h2>
                        <p>Enter your name to access your team's evaluations</p>
                        
                        <div class="form-group">
                            <label for="reviewerName">Full Name:</label>
                            <input type="text" id="reviewerName" placeholder="Enter your full name (e.g., Sarah Johnson)" onkeypress="if(event.key==='Enter') loginReviewer()">
                        </div>
                        
                        <button class="btn btn-primary" onclick="loginReviewer()">Access Dashboard</button>
                        
                        <div class="demo-reviewers">
                            <h4>Demo Reviewer Accounts:</h4>
                            <button class="btn btn-outline" onclick="loginAsDemo('sarah.johnson', 'Sarah Johnson')">Sarah Johnson (Manager)</button>
                            <button class="btn btn-outline" onclick="loginAsDemo('mike.chen', 'Mike Chen')">Mike Chen (Director)</button>
                            <button class="btn btn-outline" onclick="loginAsDemo('lisa.williams', 'Lisa Williams')">Lisa Williams (VP)</button>
                        </div>
                        
                        <div class="quick-guide">
                            <h4>📋 Quick Guide</h4>
                            <div class="guide-steps">
                                <div class="guide-step">1. Add employees</div>
                                <div class="guide-step">2. Select from dropdown</div>
                                <div class="guide-step">3. Complete 7 evaluation steps</div>
                                <div class="guide-step">4. Download PDF for calibration</div>
                            </div>
                            <p class="guide-note">✓ Auto-saves your progress • ⚠️ Detects bias</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function loginReviewer() {
            const reviewerName = document.getElementById('reviewerName').value.trim();
            
            if (!reviewerName) {
                alert('Please enter your full name');
                return;
            }
            
            // Auto-generate reviewer ID from name (e.g., "Sarah Johnson" -> "sarah.johnson")
            const reviewerId = reviewerName.toLowerCase().replace(/\s+/g, '.').replace(/[^a-z0-9.]/g, '');
            
            currentReviewer = reviewerId;
            
            // Initialize reviewer data if doesn't exist
            if (!reviewerData[reviewerId]) {
                reviewerData[reviewerId] = {
                    name: reviewerName,
                    employees: {},
                    createdDate: new Date().toISOString()
                };
            }
            
            // Update URL and load dashboard
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('reviewer', reviewerId);
            window.history.pushState({}, '', newUrl);
            
            loadReviewerDashboard();
        }

        function loginAsDemo(reviewerId, reviewerName) {
            currentReviewer = reviewerId;
            
            // Create demo data if doesn't exist
            if (!reviewerData[reviewerId]) {
                reviewerData[reviewerId] = {
                    name: reviewerName,
                    employees: generateDemoEmployees(reviewerId),
                    createdDate: new Date().toISOString()
                };
                saveReviewerData();
            }
            
            // Update URL and load dashboard
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('reviewer', reviewerId);
            window.history.pushState({}, '', newUrl);
            
            loadReviewerDashboard();
        }

        function generateDemoEmployees(reviewerId) {
            const demoSets = {
                'sarah.johnson': [
                    { id: 'emp001', name: 'Jennifer Martinez', position: 'Marketing Specialist', status: 'completed' },
                    { id: 'emp002', name: 'David Thompson', position: 'Brand Manager', status: 'in-progress' },
                    { id: 'emp003', name: 'Amanda Chen', position: 'Digital Marketing Analyst', status: 'not-started' },
                    { id: 'emp004', name: 'Robert Garcia', position: 'Marketing Coordinator', status: 'completed' }
                ],
                'mike.chen': [
                    { id: 'emp005', name: 'Emily Rodriguez', position: 'Senior Marketing Manager', status: 'completed' },
                    { id: 'emp006', name: 'James Wilson', position: 'Product Marketing Lead', status: 'in-progress' },
                    { id: 'emp007', name: 'Michelle Kim', position: 'Marketing Operations Manager', status: 'completed' },
                    { id: 'emp008', name: 'Christopher Lee', position: 'Content Marketing Manager', status: 'not-started' },
                    { id: 'emp009', name: 'Ashley Davis', position: 'Campaign Manager', status: 'in-progress' }
                ],
                'lisa.williams': [
                    { id: 'emp010', name: 'Michael Brown', position: 'Marketing Director', status: 'completed' },
                    { id: 'emp011', name: 'Jessica Anderson', position: 'Brand Director', status: 'completed' },
                    { id: 'emp012', name: 'Thomas Miller', position: 'Digital Marketing Director', status: 'in-progress' }
                ]
            };
            
            const employees = {};
            (demoSets[reviewerId] || []).forEach(emp => {
                employees[emp.id] = {
                    ...emp,
                    evaluationData: emp.status === 'completed' ? generateSampleEvaluation(emp) : {},
                    lastUpdated: new Date().toISOString()
                };
            });
            
            return employees;
        }

        function generateSampleEvaluation(employee) {
            return {
                employeeName: employee ? employee.name : 'Sample Employee',
                reviewerName: 'Sample Reviewer',
                reviewPeriod: 'FY26',
                overallRating: 'successful',
                keyPriorities: 'Achieved key marketing objectives including 15% increase in campaign engagement and successful launch of Q3 product promotion.',
                resultsImpact: 'Delivered measurable business impact with $2.3M in attributable revenue and 23% improvement in lead quality metrics.',
                collaboration: 'Built strong partnerships with cross-functional teams, facilitating weekly stakeholder meetings and resolving project conflicts.',
                growth: 'Completed advanced analytics certification and demonstrated improved data visualization skills in quarterly presentations.',
                lookingAhead: 'Recommend development in strategic planning and leadership capabilities through stretch assignment leading the Q1 campaign initiative.'
            };
        }

        function goToStep(step) {
            // Record navigation action for undo/redo (if step is actually changing)
            if (currentStep !== step && typeof recordAction !== 'undefined') {
                recordAction({
                    type: 'step_navigation',
                    oldStep: currentStep,
                    newStep: step,
                    description: `Navigate to step ${step + 1}`
                });
            }
            
            // Hide all slides
            document.querySelectorAll('.slide').forEach(slide => {
                slide.classList.remove('active');
            });

            // Show target slide
            document.getElementById(`slide-${step}`).classList.add('active');

            // Update progress steps (both horizontal navigation and any other step elements)
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                if (index === step) {
                    stepEl.classList.add('active');
                } else if (index < step) {
                    stepEl.classList.add('completed');
                }
            });

            // Update current step
            currentStep = step;

            // Update navigation
            updateNavigation();
            
            // Update progress indicator
            updateProgressIndicator();
        }

        function previousStep() {
            if (currentStep > 0) {
                goToStep(currentStep - 1);
            }
        }

        function nextStep() {
            if (currentStep < totalSteps - 1) {
                goToStep(currentStep + 1);
            } else {
                // Complete evaluation
                alert('Evaluation completed! Summary functionality can be added next.');
            }
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const stepInfo = document.getElementById('stepInfo');

            prevBtn.disabled = (currentStep === 0);
            nextBtn.textContent = (currentStep === totalSteps - 1) ? 'Complete Evaluation' : 'Next';
            stepInfo.textContent = `Step ${currentStep + 1} of ${totalSteps}`;
        }

        function updateProgressIndicator() {
            const progressPercentage = document.getElementById('progressPercentage');
            const progressBarFill = document.getElementById('progressBarFill');
            const progressCurrentStep = document.getElementById('progressCurrentStep');
            
            if (!progressPercentage) return; // Not in evaluation mode
            
            const stepNames = [
                'Basic Information & Overall Rating',
                'Key Priorities',
                'Results & Impact',
                'Collaboration & Influence',
                'Growth & Development',
                'Looking Ahead',
                'Comprehensive Summary'
            ];
            
            // Calculate completion percentage
            const completionPercent = Math.round(((currentStep + 1) / totalSteps) * 100);
            
            // Update progress elements
            progressPercentage.textContent = `${completionPercent}%`;
            progressBarFill.style.width = `${completionPercent}%`;
            progressCurrentStep.textContent = `Step ${currentStep + 1} of ${totalSteps}: ${stepNames[currentStep] || 'Unknown Step'}`;
        }

        function selectRating(element, rating) {
            // Get current rating for undo functionality
            const employee = reviewerData[currentReviewer]?.employees[currentEmployee];
            const oldRating = employee?.evaluationData?.overallRating || null;
            
            // Record action for undo/redo (if rating is actually changing)
            if (oldRating !== rating) {
                recordAction({
                    type: 'rating_change',
                    oldRating: oldRating,
                    newRating: rating,
                    description: `Change rating to ${rating}`
                });
            }
            
            // Remove selected class from all rating buttons
            document.querySelectorAll('.rating-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Add selected class to clicked button
            element.classList.add('selected');
            
            // Direct status change for completed evaluations
            if (employee && employee.status === 'completed') {
                const currentRating = employee.evaluationData?.overallRating;
                if (currentRating && currentRating !== rating) {
                    // DIRECTLY change status to in-progress
                    employee.status = 'in-progress';
                    employee.statusChangeReason = 'Overall rating modified';
                    employee.lastUpdated = new Date().toISOString();
                    
                    // Update the rating in evaluation data
                    employee.evaluationData.overallRating = rating;
                    
                    // Save immediately
                    saveReviewerData();
                    
                    // Update status display
                    updateStatusDisplay();
                    
                    // Auto-regenerate comprehensive summary if on that step
                    if (currentStep === 6) {
                        setTimeout(() => {
                            generateComprehensiveSummary();
                        }, 200);
                    }
                    
                    // Show notification
                    showStatusChangeNotification('Overall Rating', 'Completed', 'In Progress');
                    
                    console.log(`Status changed from completed to in-progress due to rating change: ${currentRating} → ${rating}`);
                    return; // Exit early, no need for auto-save
                }
            }
            
            // For non-completed evaluations, just save normally
            setTimeout(saveEmployeeEvaluation, 100);
        }

        function addSuggestion(fieldId, text) {
            const textarea = document.getElementById(fieldId);
            if (textarea.value.trim()) {
                textarea.value += ' ' + text;
            } else {
                textarea.value = text;
            }
            textarea.focus();
            
            // Mark that this content came from a suggestion (for more realistic analysis)
            textarea.setAttribute('data-has-suggestions', 'true');
            
            // Trigger analysis after suggestion is added
            setTimeout(() => {
                analyzeFeedback(fieldId);
            }, 100);
        }

        // Bias Detection and AI Writing Coach
        function analyzeFeedback(fieldId) {
            const textarea = document.getElementById(fieldId);
            const text = textarea.value.trim();
            const coach = document.getElementById(`coach-${fieldId}`);
            
            if (text.length < 10) {
                coach.style.display = 'none';
                return;
            }
            
            coach.style.display = 'block';
            
            // Calculate metrics based on section type
            const objectivity = calculateObjectivity(text, fieldId);
            const specificity = calculateSpecificity(text, fieldId);
            const completeness = calculateCompleteness(text, fieldId);
            
            // Update metrics display
            updateMetric(`objectivity-${fieldId}`, objectivity);
            updateMetric(`specificity-${fieldId}`, specificity);
            updateMetric(`completeness-${fieldId}`, completeness);
            
            // Detect bias patterns specific to section
            const biasAlerts = detectBias(text, fieldId);
            displayBiasAlerts(`alerts-${fieldId}`, biasAlerts);
        }
        
        function calculateObjectivity(text, fieldId) {
            const textarea = document.getElementById(fieldId);
            const hasSuggestions = textarea && textarea.getAttribute('data-has-suggestions') === 'true';
            
            // Expanded subjective words list for better detection
            const subjectiveWords = ['good', 'bad', 'great', 'poor', 'nice', 'awesome', 'terrible', 'amazing', 'horrible', 'fantastic', 'awful', 'disappointing', 'impressive', 'wonderful', 'brilliant', 'mediocre', 'excellent', 'outstanding', 'exceptional', 'superb', 'magnificent', 'fabulous', 'marvelous', 'tremendous', 'incredible', 'unbelievable', 'phenomenal', 'remarkable', 'extraordinary', 'sensational', 'spectacular', 'dreadful', 'appalling', 'atrocious', 'abysmal', 'horrendous', 'ghastly', 'abominable'];
            
            // More realistic objective indicators
            const objectiveIndicators = {
                keyPriorities: ['achieved target of', 'completed by deadline', 'delivered on time', 'met milestone', 'exceeded target', 'on schedule', 'within budget', 'project completed', 'goal reached', 'objective met'],
                resultsImpact: ['increased by X%', 'decreased costs by', 'generated $X', 'saved $X', 'improved efficiency by', 'ROI of X%', 'KPI improved from X to Y', 'revenue increased', 'market share gained', 'customer satisfaction score'],
                collaboration: ['collaborated with [specific team]', 'facilitated X meetings', 'coordinated project with', 'resolved conflict between', 'improved team efficiency by', 'established partnership with'],
                growth: ['completed [specific] training', 'earned [specific] certification', 'developed competency in', 'mastered [specific] skill', 'improved performance by', 'learned [specific] technology'],
                lookingAhead: ['needs development in [specific area]', 'training required for', 'stretch assignment in', 'skill gap identified in', 'next role preparation', 'development plan for']
            };
            
            const words = text.toLowerCase().split(/\W+/);
            const phrases = text.toLowerCase();
            
            // Count subjective words
            const subjectiveCount = words.filter(word => subjectiveWords.includes(word)).length;
            
            // Count vague phrases that reduce objectivity
            const vagueIndicators = ['did well', 'performed good', 'worked hard', 'tried their best', 'made an effort', 'showed improvement', 'was successful', 'did a good job', 'performed as expected', 'met expectations'];
            let vagueCount = 0;
            vagueIndicators.forEach(phrase => {
                if (phrases.includes(phrase)) vagueCount++;
            });
            
            // Count objective indicators
            let objectiveCount = 0;
            if (objectiveIndicators[fieldId]) {
                objectiveIndicators[fieldId].forEach(indicator => {
                    if (phrases.includes(indicator.toLowerCase())) objectiveCount++;
                });
            }
            
            // Add general objective words (but be more selective)
            const generalObjective = ['implemented', 'managed X employees', 'led project', 'created solution', 'designed process', 'analyzed data', 'measured results', 'tracked progress', 'documented outcomes'];
            objectiveCount += words.filter(word => generalObjective.includes(word)).length;
            
            // Count specific numbers, dates, percentages
            const numberMatches = text.match(/\d+%|\$\d+|\d+\.\d+|\d{1,2}\/\d{1,2}\/\d{2,4}/g);
            if (numberMatches) objectiveCount += numberMatches.length;
            
            // Penalty for using mostly suggestions without specific details
            if (hasSuggestions && text.length < 100) {
                objectiveCount = Math.max(0, objectiveCount - 2);
            }
            
            // Calculate score more realistically
            const totalWords = subjectiveCount + objectiveCount + vagueCount;
            if (totalWords === 0) return 45; // Default moderate score for empty content
            
            let objectivityScore = Math.round((objectiveCount / totalWords) * 100);
            
            // Apply penalties for common issues
            if (subjectiveCount > objectiveCount) objectivityScore = Math.max(20, objectivityScore - 15);
            if (vagueCount > 2) objectivityScore = Math.max(30, objectivityScore - 10);
            if (hasSuggestions && objectiveCount === 0) objectivityScore = Math.max(35, objectivityScore);
            
            // Cap maximum score to be more realistic
            return Math.min(85, Math.max(20, objectivityScore));
        }
        
        function calculateSpecificity(text, fieldId) {
            const textarea = document.getElementById(fieldId);
            const hasSuggestions = textarea && textarea.getAttribute('data-has-suggestions') === 'true';
            
            // Look for ACTUAL specific details, not just keywords
            const specificityIndicators = {
                keyPriorities: ['specific project name', 'Q[1-4] 20XX', 'by [specific date]', '[X]% target', '$[amount]', 'within [timeframe]', '[specific metric] improved'],
                resultsImpact: ['increased revenue by [X]%', 'saved $[amount]', 'improved [metric] from X to Y', 'ROI of [X]%', 'generated $[amount]', '[specific KPI] reached [number]'],
                collaboration: ['worked with [specific team/person]', '[X] stakeholders', '[specific department]', 'facilitated [X] meetings', 'resolved [specific] conflict'],
                growth: ['completed [specific] certification', '[course name]', 'learned [specific technology]', 'improved [skill] by [measure]', '[training program name]'],
                lookingAhead: ['needs training in [specific skill]', '[specific role] preparation', 'development in [area]', '[specific] stretch assignment', 'skill gap: [specific area]']
            };
            
            // Vague phrases that reduce specificity
            const vagueIndicators = ['did well', 'performed good', 'worked hard', 'tried their best', 'made an effort', 'showed improvement', 'was successful', 'did a good job', 'performed as expected', 'handled responsibilities', 'contributed to', 'participated in', 'involved in', 'supported the team', 'helped with', 'assisted', 'various projects', 'multiple initiatives', 'several tasks', 'different activities'];
            
            let specificCount = 0;
            let vagueCount = 0;
            
            const lowerText = text.toLowerCase();
            
            // Count actual numbers, percentages, dates, dollar amounts
            const numberMatches = text.match(/\d+%|\$\d+,?\d*|\d+\.\d+%?|\d{1,2}\/\d{1,2}\/\d{2,4}|\b\d+\s*(million|thousand|k|%)\b/gi);
            if (numberMatches) {
                specificCount += numberMatches.length * 2; // Weight numbers highly
            }
            
            // Count specific names, dates, timeframes
            const nameMatches = text.match(/[A-Z][a-z]+ [A-Z][a-z]+|Q[1-4] 20\d{2}|[A-Z][a-z]+ 20\d{2}|Project [A-Z][a-z]+/g);
            if (nameMatches) {
                specificCount += nameMatches.length;
            }
            
            // Look for "from X to Y" patterns
            const improvementPatterns = text.match(/from \d+.* to \d+|increased.*by \d+|decreased.*by \d+|improved.*from.*to/gi);
            if (improvementPatterns) {
                specificCount += improvementPatterns.length * 2;
            }
            
            // Count vague phrases (penalize these)
            vagueIndicators.forEach(phrase => {
                if (lowerText.includes(phrase)) vagueCount++;
            });
            
            // Check for incomplete suggestions (ends with "...")
            const incompleteCount = (text.match(/\.\.\./g) || []).length;
            
            // Penalty for mostly suggestion-based content without completion
            let penalty = 0;
            if (hasSuggestions) {
                if (incompleteCount > 0) penalty += 15; // Incomplete suggestions
                if (text.length < 80) penalty += 10; // Too short for specificity
                if (specificCount === 0) penalty += 20; // No specific details added
            }
            
            // Calculate base score
            const totalElements = specificCount + vagueCount + 1;
            let specificityScore = Math.round((specificCount / totalElements) * 100);
            
            // Apply penalties
            specificityScore = Math.max(15, specificityScore - penalty);
            
            // Penalize high vague count
            if (vagueCount > specificCount) {
                specificityScore = Math.max(25, specificityScore - 15);
            }
            
            // Section-specific adjustments
            if (fieldId === 'lookingAhead') {
                // Looking Ahead should focus on specific development areas
                if (text.includes('development') && specificCount === 0) {
                    specificityScore = Math.max(30, specificityScore - 10);
                }
            }
            
            // Cap the maximum to be more realistic
            return Math.min(80, Math.max(20, specificityScore));
        }
        
        function calculateCompleteness(text, fieldId) {
            const words = text.split(/\W+/).filter(word => word.length > 0);
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            
            // Section-specific completeness requirements
            const requiredElements = {
                keyPriorities: ['goals', 'objectives', 'deliverables', 'timeline', 'scope', 'priorities'],
                resultsImpact: ['outcome', 'result', 'impact', 'metric', 'measurement', 'business value', 'achievement'],
                collaboration: ['partnership', 'teamwork', 'communication', 'stakeholder', 'cross-functional', 'relationship'],
                growth: ['skill', 'development', 'learning', 'improvement', 'competency', 'capability', 'knowledge'],
                lookingAhead: ['opportunity', 'development', 'growth area', 'next steps', 'future', 'recommendation', 'plan']
            };
            
            let score = 0;
            
            // Word count scoring (adjusted per section)
            const minWords = fieldId === 'lookingAhead' ? 40 : 30; // Looking ahead needs more detail
            if (words.length >= minWords + 20) score += 35;
            else if (words.length >= minWords) score += 25;
            else if (words.length >= minWords - 10) score += 15;
            else score += 5;
            
            // Sentence structure scoring
            const minSentences = 3;
            if (sentences.length >= minSentences + 2) score += 25;
            else if (sentences.length >= minSentences) score += 20;
            else if (sentences.length >= 2) score += 15;
            else score += 5;
            
            // Section-specific content elements
            if (requiredElements[fieldId]) {
                const elementCount = requiredElements[fieldId].filter(element => 
                    text.toLowerCase().includes(element)
                ).length;
                
                if (elementCount >= 3) score += 25;
                else if (elementCount >= 2) score += 20;
                else if (elementCount >= 1) score += 15;
                else score += 5;
            }
            
            // Evidence and examples
            const evidenceIndicators = ['for example', 'specifically', 'such as', 'including', 'demonstrated by', 'evidenced by', 'shown through'];
            const evidenceCount = evidenceIndicators.filter(indicator => text.toLowerCase().includes(indicator)).length;
            
            if (evidenceCount >= 2) score += 15;
            else if (evidenceCount >= 1) score += 10;
            else score += 5;
            
            return Math.min(100, score);
        }
        
        function detectBias(text, fieldId) {
            const alerts = [];
            const lowerText = text.toLowerCase();
            
            // Advanced bias analysis - evaluate content substance and reasoning patterns
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 10);
            const substantiveAnalysis = analyzeContentSubstance(text, sentences, fieldId);
            
            // Check for surface-level compliance vs. substantive content
            if (substantiveAnalysis.hasKeywords && !substantiveAnalysis.hasSubstance) {
                alerts.push('🎭 <strong>Surface Compliance:</strong> Contains expected keywords but lacks substantive analysis. Provide deeper context and specific reasoning.');
            }
            
            // Section-specific bias detection with substance analysis
            if (fieldId === 'keyPriorities') {
                const hasMetrics = text.match(/\d+%|\$\d+|Q[1-4]|FY\d+/);
                const hasContext = analyzeGoalContext(text, sentences);
                
                if (hasMetrics && !hasContext.meaningful) {
                    alerts.push('📊 <strong>Metric Without Context:</strong> Numbers provided but missing explanation of how goals connect to role expectations or business impact.');
                }
                
                if (!hasMetrics && !hasContext.qualitative) {
                    alerts.push('� <strong>Vague Priorities:</strong> Neither quantitative metrics nor qualitative context provided. Include either specific targets or detailed role expectations.');
                }
            }
            
            if (fieldId === 'resultsImpact') {
                const hasMetrics = text.match(/\d+%|\$\d+|\d+\.\d+|increased|decreased|improved/);
                const impactAnalysis = analyzeImpactSubstance(text, sentences);
                
                if (hasMetrics && !impactAnalysis.causalConnection) {
                    alerts.push('� <strong>Missing Causation:</strong> Metrics provided but no clear connection between employee actions and results. Explain how their work directly contributed to outcomes.');
                }
                
                if (hasMetrics && !impactAnalysis.contextualMeaning) {
                    alerts.push('📈 <strong>Context Missing:</strong> Numbers lack context. Explain what these results mean compared to targets, previous periods, or industry benchmarks.');
                }
                
                if (!hasMetrics && !impactAnalysis.qualitativeImpact) {
                    alerts.push('💼 <strong>Unclear Impact:</strong> No quantitative or qualitative evidence of business impact. Provide either metrics or detailed description of value created.');
                }
                
                // Check for attribution inflation
                if (impactAnalysis.inflatedClaims) {
                    alerts.push('⚠️ <strong>Attribution Bias:</strong> Claims may overstate individual contribution to team/company results. Clarify specific individual role vs. team effort.');
                }
            }
            
            if (fieldId === 'collaboration') {
                const collaborationAnalysis = analyzeCollaborationSubstance(text, sentences);
                
                if (collaborationAnalysis.hasKeywords && !collaborationAnalysis.hasSpecificExamples) {
                    alerts.push('🤝 <strong>Generic Collaboration:</strong> Uses collaboration terms but lacks specific examples of partnership challenges, methods, or outcomes.');
                }
                
                if (collaborationAnalysis.inflatedTeamwork) {
                    alerts.push('👥 <strong>Teamwork Inflation:</strong> Claims about collaboration may be overstated. Provide specific examples of how they facilitated, mediated, or contributed to team success.');
                }
                
                if (collaborationAnalysis.vagueCommunication) {
                    alerts.push('💬 <strong>Communication Clichés:</strong> Avoid general statements like "great communicator." Describe specific communication challenges solved or methods used.');
                }
                
                // Check for conflict avoidance in feedback
                if (!lowerText.includes('challenge') && !lowerText.includes('difficult') && !lowerText.includes('conflict') && sentences.length > 2) {
                    alerts.push('� <strong>Overly Positive:</strong> No challenges or growth areas mentioned. Real collaboration involves navigating difficulties - consider balanced feedback.');
                }
            }
            
            if (fieldId === 'growth') {
                const growthAnalysis = analyzeGrowthSubstance(text, sentences);
                
                if (growthAnalysis.hasGrowthKeywords && !growthAnalysis.hasEvidence) {
                    alerts.push('📚 <strong>Growth Without Evidence:</strong> Claims development but provides no specific evidence. Include before/after examples or concrete learning outcomes.');
                }
                
                if (growthAnalysis.trainingMentioned && !growthAnalysis.applicationEvidence) {
                    alerts.push('🎯 <strong>Training Without Application:</strong> Lists training but doesn\'t show how learning was applied to work. Connect development activities to job performance.');
                }
                
                if (growthAnalysis.inflatedGrowth) {
                    alerts.push('📈 <strong>Growth Inflation:</strong> Development claims may be overstated for the time period. Ensure growth described is realistic and observable.');
                }
                
                // Check for growth plateau indicators
                if (lowerText.includes('maintains') || lowerText.includes('continues to') || lowerText.includes('still')) {
                    alerts.push('� <strong>Plateau Language:</strong> Language suggests maintaining status quo rather than growth. Consider what new capabilities were actually developed.');
                }
            }
            
            if (fieldId === 'lookingAhead') {
                const futureAnalysis = analyzeFutureSubstance(text, sentences);
                
                if (futureAnalysis.hasRecommendations && !futureAnalysis.hasReasoning) {
                    alerts.push('🤔 <strong>Recommendations Without Reasoning:</strong> Suggests development but doesn\'t explain why these areas were chosen or how they connect to performance gaps.');
                }
                
                if (futureAnalysis.genericDevelopment) {
                    alerts.push('📋 <strong>Generic Development:</strong> Development suggestions are too broad. Connect specific growth areas to role requirements or career progression.');
                }
                
                if (futureAnalysis.avoidsDifficultConversation) {
                    alerts.push('💬 <strong>Avoiding Tough Feedback:</strong> May be avoiding necessary but difficult developmental conversations. Consider what growth truly requires.');
                }
                
                // Check for unrealistic expectations
                if (futureAnalysis.unrealisticTimeline) {
                    alerts.push('⏰ <strong>Timeline Reality Check:</strong> Development expectations may be unrealistic for timeframe. Ensure suggestions are achievable within next review period.');
                }
            }
            
            // Universal bias checks with advanced pattern analysis
            
            // Sophisticated Easy Rater Detection
            const easyRaterAnalysis = detectEasyRaterPatterns(text, sentences);
            if (easyRaterAnalysis.isEasyRating) {
                alerts.push(`⚠️ <strong>Easy Rater Pattern:</strong> ${easyRaterAnalysis.reason}`);
            }
            
            // Logical consistency check
            const consistencyAnalysis = analyzeLogicalConsistency(text, sentences, fieldId);
            if (consistencyAnalysis.hasInconsistency) {
                alerts.push(`🔍 <strong>Logical Inconsistency:</strong> ${consistencyAnalysis.issue}`);
            }
            
            // Vague Language Detection
            const vagueWords = ['good', 'nice', 'fine', 'okay', 'decent', 'alright', 'satisfactory'];
            const vagueCount = vagueWords.filter(word => lowerText.includes(word)).length;
            
            if (vagueCount >= 2) {
                alerts.push('⚠️ <strong>Vague Language:</strong> Replace general terms with specific behaviors, outcomes, or examples.');
            }
            
            // Gender/Demographic Bias Detection
            const biasTerms = ['aggressive', 'bossy', 'emotional', 'nurturing', 'soft-spoken', 'cultural fit', 'natural leader'];
            const biasFound = biasTerms.some(term => lowerText.includes(term));
            
            if (biasFound) {
                alerts.push('⚠️ <strong>Potential Bias:</strong> Review language for unconscious bias. Focus on specific behaviors and measurable outcomes.');
            }
            
            // Recency Bias Detection
            const recentWords = ['recently', 'last week', 'yesterday', 'just completed', 'latest', 'this month'];
            const recentCount = recentWords.filter(word => lowerText.includes(word)).length;
            
            if (recentCount >= 2) {
                alerts.push('⚠️ <strong>Recency Bias:</strong> Ensure feedback represents the entire review period, not just recent events.');
            }
            
            return alerts;
        }
        
        function updateMetric(metricId, value) {
            const metric = document.getElementById(metricId);
            const valueSpan = metric.querySelector('.metric-value');
            
            valueSpan.textContent = `${value}%`;
            
            // Update styling based on value
            metric.classList.remove('good', 'warning', 'poor');
            if (value >= 70) {
                metric.classList.add('good');
            } else if (value >= 40) {
                metric.classList.add('warning');
            } else {
                metric.classList.add('poor');
            }
        }
        
        function displayBiasAlerts(alertsId, alerts) {
            const alertsContainer = document.getElementById(alertsId);
            
            if (alerts.length === 0) {
                alertsContainer.innerHTML = '<div class="bias-alert" style="color: #28a745;">✅ No bias patterns detected. Great objective feedback!</div>';
            } else {
                alertsContainer.innerHTML = alerts.map(alert => `<div class="bias-alert">${alert}</div>`).join('');
            }
        }

        // Advanced Bias Analysis Functions
        
        function analyzeContentSubstance(text, sentences, fieldId) {
            const lowerText = text.toLowerCase();
            
            // Check if text has expected keywords but lacks substance
            const expectedKeywords = {
                keyPriorities: ['goal', 'priority', 'objective', 'target', 'deliverable'],
                resultsImpact: ['result', 'impact', 'outcome', 'achievement', 'delivered'],
                collaboration: ['team', 'partner', 'stakeholder', 'cross-functional'],
                growth: ['develop', 'learn', 'skill', 'training', 'improve'],
                lookingAhead: ['opportunity', 'development', 'next', 'future', 'recommend']
            };
            
            const relevantKeywords = expectedKeywords[fieldId] || [];
            const keywordCount = relevantKeywords.filter(keyword => lowerText.includes(keyword)).length;
            
            // Check for substance indicators
            const substanceIndicators = [
                'because', 'therefore', 'however', 'specifically', 'for example', 
                'demonstrated by', 'evidenced through', 'resulting in', 'which led to',
                'by doing', 'through', 'via', 'when', 'during', 'after'
            ];
            
            const substanceCount = substanceIndicators.filter(indicator => lowerText.includes(indicator)).length;
            const avgWordsPerSentence = text.split(/\s+/).length / Math.max(sentences.length, 1);
            
            return {
                hasKeywords: keywordCount >= 1,
                hasSubstance: substanceCount >= 1 || avgWordsPerSentence > 15,
                substanceRatio: substanceCount / Math.max(sentences.length, 1)
            };
        }
        
        function analyzeGoalContext(text, sentences) {
            const lowerText = text.toLowerCase();
            
            const contextIndicators = [
                'role requires', 'expected to', 'responsible for', 'accountable for',
                'business objective', 'strategic goal', 'department target', 'company priority'
            ];
            
            const qualitativeDescriptors = [
                'complex', 'challenging', 'critical', 'high-priority', 'time-sensitive',
                'cross-departmental', 'customer-facing', 'revenue-generating'
            ];
            
            return {
                meaningful: contextIndicators.some(indicator => lowerText.includes(indicator)),
                qualitative: qualitativeDescriptors.some(descriptor => lowerText.includes(descriptor))
            };
        }
        
        function analyzeImpactSubstance(text, sentences) {
            const lowerText = text.toLowerCase();
            
            // Check for causal connection words
            const causalWords = ['by', 'through', 'because', 'resulted in', 'led to', 'caused', 'enabled', 'contributed to'];
            const hasCausalConnection = causalWords.some(word => lowerText.includes(word));
            
            // Check for contextual meaning
            const contextWords = ['compared to', 'versus', 'target was', 'baseline', 'previous year', 'industry average', 'benchmark'];
            const hasContextualMeaning = contextWords.some(word => lowerText.includes(word));
            
            // Check for qualitative impact
            const qualitativeImpact = ['customer satisfaction', 'team morale', 'process efficiency', 'brand reputation', 'market position'];
            const hasQualitativeImpact = qualitativeImpact.some(impact => lowerText.includes(impact));
            
            // Check for attribution inflation
            const inflationWords = ['single-handedly', 'solely responsible', 'entirely due to', 'completely transformed'];
            const inflatedClaims = inflationWords.some(word => lowerText.includes(word));
            
            return {
                causalConnection: hasCausalConnection,
                contextualMeaning: hasContextualMeaning,
                qualitativeImpact: hasQualitativeImpact,
                inflatedClaims: inflatedClaims
            };
        }
        
        function analyzeCollaborationSubstance(text, sentences) {
            const lowerText = text.toLowerCase();
            
            const keyWords = ['team', 'collaboration', 'partnership', 'cross-functional'];
            const hasKeywords = keyWords.some(word => lowerText.includes(word));
            
            // Check for specific examples
            const specificExamples = ['project', 'initiative', 'meeting', 'presentation', 'conflict resolution', 'facilitated'];
            const hasSpecificExamples = specificExamples.some(example => lowerText.includes(example));
            
            // Check for teamwork inflation
            const inflationTerms = ['natural born leader', 'everyone loves', 'perfect team player', 'never any conflicts'];
            const inflatedTeamwork = inflationTerms.some(term => lowerText.includes(term));
            
            // Check for vague communication
            const vagueTerms = ['great communicator', 'excellent people skills', 'good with people', 'strong interpersonal'];
            const vagueCommunication = vagueTerms.some(term => lowerText.includes(term)) && !hasSpecificExamples;
            
            return {
                hasKeywords,
                hasSpecificExamples,
                inflatedTeamwork,
                vagueCommunication
            };
        }
        
        function analyzeGrowthSubstance(text, sentences) {
            const lowerText = text.toLowerCase();
            
            const growthKeywords = ['grew', 'developed', 'learned', 'improved', 'advanced'];
            const hasGrowthKeywords = growthKeywords.some(word => lowerText.includes(word));
            
            // Check for evidence
            const evidenceWords = ['completed', 'achieved', 'demonstrated', 'applied', 'implemented', 'showed'];
            const hasEvidence = evidenceWords.some(word => lowerText.includes(word));
            
            // Check for training mention vs application
            const trainingMentioned = lowerText.includes('training') || lowerText.includes('course') || lowerText.includes('certification');
            const applicationWords = ['used', 'applied', 'implemented', 'practiced', 'utilized'];
            const applicationEvidence = applicationWords.some(word => lowerText.includes(word));
            
            // Check for inflated growth claims
            const inflationWords = ['completely transformed', 'dramatically improved', 'revolutionary change', 'total makeover'];
            const inflatedGrowth = inflationWords.some(word => lowerText.includes(word));
            
            return {
                hasGrowthKeywords,
                hasEvidence,
                trainingMentioned,
                applicationEvidence,
                inflatedGrowth
            };
        }
        
        function analyzeFutureSubstance(text, sentences) {
            const lowerText = text.toLowerCase();
            
            const recommendationWords = ['recommend', 'suggest', 'should', 'could', 'next steps'];
            const hasRecommendations = recommendationWords.some(word => lowerText.includes(word));
            
            // Check for reasoning
            const reasoningWords = ['because', 'since', 'given that', 'in order to', 'to improve', 'to enhance'];
            const hasReasoning = reasoningWords.some(word => lowerText.includes(word));
            
            // Check for generic development
            const genericTerms = ['leadership skills', 'communication', 'time management', 'general improvement'];
            const specificTerms = ['Excel proficiency', 'Python programming', 'customer segmentation analysis'];
            const genericDevelopment = genericTerms.some(term => lowerText.includes(term)) && 
                                     !specificTerms.some(term => lowerText.includes(term));
            
            // Check if avoiding difficult conversations
            const avoidanceWords = ['continue current path', 'keep up the good work', 'more of the same'];
            const avoidsDifficultConversation = avoidanceWords.some(word => lowerText.includes(word));
            
            // Check for unrealistic timeline
            const urgentWords = ['immediately', 'by next month', 'within weeks', 'right away'];
            const unrealisticTimeline = urgentWords.some(word => lowerText.includes(word));
            
            return {
                hasRecommendations,
                hasReasoning,
                genericDevelopment,
                avoidsDifficultConversation,
                unrealisticTimeline
            };
        }
        
        function detectEasyRaterPatterns(text, sentences) {
            const lowerText = text.toLowerCase();
            
            // Pattern 1: High praise without evidence
            const praiseWords = ['excellent', 'outstanding', 'amazing', 'fantastic', 'brilliant', 'perfect'];
            const evidenceWords = ['because', 'demonstrated', 'achieved', 'delivered', 'resulted in'];
            const hasPraise = praiseWords.some(word => lowerText.includes(word));
            const hasEvidence = evidenceWords.some(word => lowerText.includes(word)) || text.match(/\d+%|\$\d+/);
            
            if (hasPraise && !hasEvidence && sentences.length >= 2) {
                return {
                    isEasyRating: true,
                    reason: 'High praise without supporting evidence or specific examples.'
                };
            }
            
            // Pattern 2: All positive, no growth areas
            const negativeWords = ['challenge', 'difficulty', 'improve', 'develop', 'opportunity', 'could', 'should'];
            const hasBalancedFeedback = negativeWords.some(word => lowerText.includes(word));
            
            if (sentences.length >= 3 && !hasBalancedFeedback && hasPraise) {
                return {
                    isEasyRating: true,
                    reason: 'Only positive feedback with no growth opportunities or challenges mentioned.'
                };
            }
            
            // Pattern 3: Repetitive praise
            const uniquePraiseCount = new Set(praiseWords.filter(word => lowerText.includes(word))).size;
            const totalPraiseCount = praiseWords.filter(word => lowerText.includes(word)).length;
            
            if (totalPraiseCount >= 3 && uniquePraiseCount <= 2) {
                return {
                    isEasyRating: true,
                    reason: 'Repetitive positive language without varied, specific feedback.'
                };
            }
            
            return { isEasyRating: false };
        }
        
        function analyzeLogicalConsistency(text, sentences, fieldId) {
            const lowerText = text.toLowerCase();
            
            // Check for contradictory statements
            if (lowerText.includes('excellent') && lowerText.includes('needs improvement')) {
                return {
                    hasInconsistency: true,
                    issue: 'Contains both excellent performance and improvement needs without clear context.'
                };
            }
            
            // Check for unsupported superlatives
            const superlatives = ['always', 'never', 'every time', 'constantly', 'all', 'none'];
            const hasSuperlatives = superlatives.some(word => lowerText.includes(word));
            const hasExceptions = lowerText.includes('except') || lowerText.includes('however') || lowerText.includes('sometimes');
            
            if (hasSuperlatives && !hasExceptions && sentences.length >= 2) {
                return {
                    hasInconsistency: true,
                    issue: 'Uses absolute terms (always/never) without acknowledging exceptions or context.'
                };
            }
            
            return { hasInconsistency: false };
        }

        function loadReviewerDashboard() {
            const reviewer = reviewerData[currentReviewer];
            const allEmployees = Object.values(reviewer.employees || {});
            const employees = allEmployees.filter(emp => !emp.archived);
            const archivedEmployees = allEmployees.filter(emp => emp.archived);
            
            document.querySelector('.container').innerHTML = `
                <div class="sidebar">
                    <div class="reviewer-info">
                        <h3>Welcome, ${reviewer.name}</h3>
                        <button class="btn btn-outline btn-small" onclick="logoutReviewer()">Logout</button>
                    </div>
                    
                    <div class="employee-list">
                        <h4>Direct Reports (${employees.length})</h4>
                        
                        <!-- Search Section -->
                        <div class="search-section">
                            <div class="search-container">
                                <input type="text" class="employee-search" placeholder="Search employees..." oninput="filterEmployees()" id="employeeSearch">
                                <span class="search-icon">🔍</span>
                                <button class="clear-search" onclick="clearSearch()" title="Clear search" style="display: none;">×</button>
                            </div>
                        </div>
                        
                        <!-- Sort Controls -->
                        <div class="sort-controls">
                            <button class="sort-btn active" onclick="setSortMode('alphabetical')" id="sort-alphabetical">A-Z</button>
                            <button class="sort-btn" onclick="setSortMode('status')" id="sort-status">Status</button>
                            <button class="sort-btn" onclick="setSortMode('custom')" id="sort-custom">Custom</button>
                        </div>
                        
                        <!-- Draggable Employee List -->
                        <div class="draggable-employee-list" id="draggableEmployeeList">
                            ${getSortedEmployees(employees).map(emp => `
                                <div class="employee-item ${emp.status}" 
                                     draggable="true" 
                                     data-employee-id="${emp.id}"
                                     ondragstart="handleDragStart(event)"
                                     ondragover="handleDragOver(event)"
                                     ondrop="handleDrop(event)"
                                     ondragend="handleDragEnd(event)"
                                     onclick="startEvaluation('${emp.id}')">
                                    <div class="employee-content">
                                        <span class="drag-handle">⋮⋮</span>
                                        <div class="employee-details">
                                            <div class="employee-name">${emp.name}</div>
                                            <div class="employee-position">${emp.position}</div>
                                            <div class="employee-status status-${emp.status}">
                                                ${emp.status === 'completed' ? '✓ Complete' : 
                                                  emp.status === 'in-progress' ? '⏱ In Progress' : '○ Not Started'}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="employee-actions">
                                        <button class="btn btn-download ${emp.evaluationData && Object.keys(emp.evaluationData).length > 0 ? '' : 'disabled'}" 
                                                onclick="downloadIndividualEvaluationPDF('${emp.id}', event)" 
                                                title="Download Evaluation PDF" 
                                                ${emp.evaluationData && Object.keys(emp.evaluationData).length > 0 ? '' : 'disabled'}>📄</button>
                                        <button class="btn btn-archive" onclick="archiveEmployee('${emp.id}', event)" title="Archive Employee">📁</button>
                                        <button class="btn btn-delete" onclick="deleteEmployee('${emp.id}', event)" title="Delete Employee">×</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <select class="employee-dropdown" onchange="handleEmployeeSelection(this.value)" id="employeeDropdown">
                            <option value="">Select an employee...</option>
                            ${employees
                                .sort((a, b) => {
                                    // Sort alphabetically by last name
                                    const lastNameA = a.name.split(' ').pop().toLowerCase();
                                    const lastNameB = b.name.split(' ').pop().toLowerCase();
                                    return lastNameA.localeCompare(lastNameB);
                                })
                                .map(emp => `
                                <option value="${emp.id}" data-status="${emp.status}" data-rating="${emp.evaluationData?.overallRating || 'not-set'}" data-name="${emp.name.toLowerCase()}">
                                    ${emp.name} - ${emp.status === 'completed' ? '✓ Complete' : 
                                      emp.status === 'in-progress' ? '⏱ In Progress' : '○ Not Started'}
                                </option>
                            `).join('')}
                        </select>
                        
                        <div class="employee-actions-panel" id="employee-actions-panel" style="display: none;">
                            <div class="smart-actions-list">
                                <div class="smart-action-item" onclick="startSelectedEmployeeEvaluation()">Start Evaluation</div>
                                <div class="smart-action-item" onclick="downloadSelectedEmployeePDF()">Download PDF</div>
                                <div class="smart-action-item" onclick="archiveSelectedEmployee()">Archive Employee</div>
                                <div class="smart-action-item" onclick="deleteSelectedEmployee()">Delete Employee</div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary btn-add-employee" onclick="addNewEmployee()">
                            + Add New Employee
                        </button>
                    </div>
                    
                    ${archivedEmployees.length > 0 ? `
                    <div class="archived-employees">
                        <h4>Archived Team Members (${archivedEmployees.length})</h4>
                        <div class="archived-toggle" onclick="toggleArchivedEmployees()" id="archived-toggle">
                            <span>▼ Show Archived</span>
                        </div>
                        <div class="archived-list" id="archived-list" style="display: none;">
                            ${archivedEmployees.map(emp => `
                                <div class="employee-item archived">
                                    <div class="employee-content" onclick="startEvaluation('${emp.id}')">
                                        <div class="employee-name">${emp.name}</div>
                                        <div class="employee-status archived-status">
                                            📁 Archived ${emp.archivedDate ? '(' + new Date(emp.archivedDate).toLocaleDateString() + ')' : ''}
                                        </div>
                                    </div>
                                    <div class="employee-actions">
                                        <button class="btn btn-download ${emp.evaluationData && Object.keys(emp.evaluationData).length > 0 ? '' : 'disabled'}" 
                                                onclick="downloadIndividualEvaluationPDF('${emp.id}', event)" 
                                                title="Download Evaluation PDF" 
                                                ${emp.evaluationData && Object.keys(emp.evaluationData).length > 0 ? '' : 'disabled'}>📄</button>
                                        <button class="btn btn-restore" onclick="restoreEmployee('${emp.id}', event)" title="Restore to Active Team">↩️</button>
                                        <button class="btn btn-delete" onclick="deleteEmployee('${emp.id}', event)" title="Delete Permanently">×</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="team-summary">
                        <h4>Team Summary</h4>
                        <div class="summary-stats">
                            <div class="stat">
                                <span class="stat-number">${employees.filter(e => e.status === 'completed').length}</span>
                                <span class="stat-label">Completed</span>
                            </div>
                            <div class="stat">
                                <span class="stat-number">${employees.filter(e => e.status === 'in-progress').length}</span>
                                <span class="stat-label">In Progress</span>
                            </div>
                            <div class="stat">
                                <span class="stat-number">${employees.filter(e => e.status === 'not-started').length}</span>
                                <span class="stat-label">Not Started</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="main-content">
                    <div class="content-card">
                        <div class="dashboard-welcome">
                            <p>Select a team member from the sidebar to begin or continue their performance evaluation.</p>
                            
                            <div class="quick-actions">
                                <h3>Quick Actions</h3>
                                <div class="action-buttons">
                                    <button class="btn btn-primary" onclick="viewTeamReport()">View Team Report</button>
                                    <button class="btn btn-primary" onclick="showAnalyticsInsights()">Analytics & Insights</button>
                                    <button class="btn btn-primary" onclick="exportEvaluations()">Export All Evaluations (PDF)</button>
                                </div>
                            </div>
                            
                            <div class="recent-activity">
                                <h3>Recent Activity</h3>
                                <div class="activity-list">
                                    ${employees.filter(e => e.status !== 'not-started')
                                        .sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated))
                                        .slice(0, 5)
                                        .map(emp => `
                                            <div class="activity-item">
                                                <div class="activity-main">
                                                    <div class="activity-name">${emp.name}</div>
                                                    <div class="activity-action">Evaluation ${emp.status === 'completed' ? 'completed' : 'updated'}</div>
                                                </div>
                                                <div class="activity-date">${new Date(emp.lastUpdated).toLocaleDateString()}</div>
                                            </div>
                                        `).join('') || '<div class="activity-item"><div class="activity-main"><div class="activity-name">No recent activity</div></div></div>'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function startEvaluation(employeeId) {
            currentEmployee = employeeId;
            const employee = reviewerData[currentReviewer].employees[employeeId];
            
            // Load the evaluation form
            loadEvaluationForm(employee);
        }

        function loadEvaluationForm(employee) {
            // Update the entire container to show evaluation mode
            document.querySelector('.container').innerHTML = `
                <div class="sidebar">
                    <div class="reviewer-info">
                        <h3>Welcome, ${reviewerData[currentReviewer].name}</h3>
                        <button class="btn btn-outline btn-small" onclick="logoutReviewer()">Logout</button>
                    </div>
                    
                    <!-- Current Employee Info -->
                    <div class="current-employee-info">
                        <h4>Current Evaluation</h4>
                        <div class="employee-card">
                            <div class="employee-name">${employee.name}</div>
                            <div class="employee-position">${employee.position}</div>
                            <div class="employee-status status-${employee.status}">
                                ${employee.status === 'completed' ? '✓ Complete' : 
                                  employee.status === 'in-progress' ? '⏱ In Progress' : '○ Not Started'}
                            </div>
                        </div>
                        <button class="btn btn-outline btn-small" onclick="loadReviewerDashboard()" style="margin-top: 10px; width: 100%;">
                            ← Back to Team List
                        </button>
                    </div>
                    
                    <!-- Undo/Redo Shortcuts Info -->
                    <div class="shortcuts-info">
                        <h5>Quick Actions</h5>
                        <div class="shortcut-item">
                            <kbd>Ctrl+Z</kbd> <span>Undo</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl+Shift+Z</kbd> <span>Redo</span>
                        </div>
                        <div class="shortcut-note">
                            Changes to text, ratings, and navigation can be undone
                        </div>
                    </div>
                    
                    <!-- Progress Steps -->
                    <div class="progress-steps">
                        <h4>Progress</h4>
                        <div class="step active" onclick="goToStep(0)" title="Basic Information & Rating">
                            <span class="step-number">1</span>
                            <span class="step-title">Basic Info</span>
                        </div>
                        <div class="step" onclick="goToStep(1)" title="Key Priorities">
                            <span class="step-number">2</span>
                            <span class="step-title">Key Priorities</span>
                        </div>
                        <div class="step" onclick="goToStep(2)" title="Results & Impact">
                            <span class="step-number">3</span>
                            <span class="step-title">Results & Impact</span>
                        </div>
                        <div class="step" onclick="goToStep(3)" title="Collaboration & Influence">
                            <span class="step-number">4</span>
                            <span class="step-title">Collaboration</span>
                        </div>
                        <div class="step" onclick="goToStep(4)" title="Growth & Development">
                            <span class="step-number">5</span>
                            <span class="step-title">Growth</span>
                        </div>
                        <div class="step" onclick="goToStep(5)" title="Looking Ahead">
                            <span class="step-number">6</span>
                            <span class="step-title">Looking Ahead</span>
                        </div>
                        <div class="step" onclick="goToStep(6)" title="Comprehensive Summary">
                            <span class="step-number">7</span>
                            <span class="step-title">Summary</span>
                        </div>
                    </div>
                </div>
                
                <div class="main-content">
                    <!-- Progress Indicator -->
                    <div class="progress-indicator" id="progressIndicator">
                        <div class="progress-header">
                            <div class="progress-title">Evaluation Progress</div>
                            <div class="progress-percentage" id="progressPercentage">14%</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" id="progressBarFill" style="width: 14%"></div>
                        </div>
                        <div class="progress-current-step" id="progressCurrentStep">Step 1 of 7: Basic Information & Overall Rating</div>
                    </div>
                    <!-- Horizontal Step Navigation -->
                    <div class="horizontal-step-nav">
                        <div class="step-navigation">
                            <div class="step active" onclick="goToStep(0)" title="Basic Information & Rating">1</div>
                            <div class="step" onclick="goToStep(1)" title="Key Priorities">2</div>
                            <div class="step" onclick="goToStep(2)" title="Results & Impact">3</div>
                            <div class="step" onclick="goToStep(3)" title="Collaboration & Influence">4</div>
                            <div class="step" onclick="goToStep(4)" title="Growth & Development">5</div>
                            <div class="step" onclick="goToStep(5)" title="Looking Ahead">6</div>
                            <div class="step" onclick="goToStep(6)" title="Comprehensive Summary">7</div>
                        </div>
                    </div>
                    
                    <div class="content-card">
                        <div class="evaluation-header">
                            <button class="btn btn-outline btn-back" onclick="loadReviewerDashboard()">← Back to Dashboard</button>
                            <div class="employee-info">
                                <h2>${employee.name} | ${employee.position}</h2>
                                <p class="employee-status-line">Status: <span class="status-${employee.status}">${employee.status.replace('-', ' ').toUpperCase()}</span></p>
                            </div>
                        </div>
                        
                        <!-- Insert existing evaluation form content here -->
                        ${getEvaluationFormContent(employee)}
                        
                        <!-- Navigation -->
                        <div class="navigation">
                            <button class="btn btn-outline" id="prevBtn" onclick="previousStep()" disabled>Previous</button>
                            <div class="step-info" id="stepInfo">Step 1 of 6</div>
                            <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">Next</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Reset to first step
            currentStep = 0;
            updateNavigation();
            updateProgressIndicator();
            
            // Load existing data if available
            loadEmployeeData(employee);
            
            // Setup auto-save after employee data is fully loaded
            setTimeout(setupAutoSave, 500);
        }

        function goToStep(step) {
            // Validate step range
            if (step < 0 || step >= totalSteps) {
                console.error(`Invalid step: ${step}. Valid range is 0 to ${totalSteps - 1}`);
                return;
            }
            
            // Hide all slides
            document.querySelectorAll('.slide').forEach(slide => {
                slide.classList.remove('active');
            });

            // Show target slide
            const targetSlide = document.getElementById(`slide-${step}`);
            if (targetSlide) {
                targetSlide.classList.add('active');
            }

            // Update progress steps (both progress-indicator and horizontal navigation)
            document.querySelectorAll('.progress-indicator .step, .step-navigation .step').forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                if (index === step) {
                    stepEl.classList.add('active');
                } else if (index < step) {
                    stepEl.classList.add('completed');
                }
            });

            // Update current step
            currentStep = step;

            // Auto-generate comprehensive summary when navigating to Step 7 (index 6)
            if (step === 6) {
                setTimeout(() => {
                    generateComprehensiveSummary();
                }, 200);
            }

            // Update navigation
            updateNavigation();
            
            // Save current progress
            setTimeout(saveEmployeeEvaluation, 100);
        }

        function previousStep() {
            if (currentStep > 0) {
                goToStep(currentStep - 1);
            }
        }

        function nextStep() {
            if (currentStep < totalSteps - 1) {
                goToStep(currentStep + 1);
            } else {
                // Complete evaluation - only way to set status to 'completed'
                const employee = reviewerData[currentReviewer]?.employees[currentEmployee];
                if (employee) {
                    saveEmployeeEvaluation();
                    employee.status = 'completed';
                    employee.statusChangeReason = 'Evaluation completed by reviewer';
                    employee.completedDate = new Date().toISOString();
                    saveReviewerData();
                    updateStatusDisplay();
                }
                alert('Evaluation completed! Returning to dashboard.');
                // Small delay to ensure status display updates before returning to dashboard
                setTimeout(() => {
                    loadReviewerDashboard();
                }, 100);
            }
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const stepInfo = document.getElementById('stepInfo');

            if (prevBtn) prevBtn.disabled = (currentStep === 0);
            if (nextBtn) nextBtn.textContent = (currentStep === totalSteps - 1) ? 'Complete Evaluation' : 'Next';
            if (stepInfo) stepInfo.textContent = `Step ${currentStep + 1} of ${totalSteps}`;
        }

        function selectRating(element, rating) {
            // Remove selected class from all rating buttons
            document.querySelectorAll('.rating-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Add selected class to clicked button
            element.classList.add('selected');
            
            // Save the selection
            setTimeout(saveEmployeeEvaluation, 100);
        }

        function addSuggestion(fieldId, text) {
            const textarea = document.getElementById(fieldId);
            if (textarea) {
                if (textarea.value.trim()) {
                    textarea.value += ' ' + text;
                } else {
                    textarea.value = text;
                }
                textarea.focus();
                
                // Trigger analysis and auto-save
                analyzeFeedback(fieldId);
                setTimeout(saveEmployeeEvaluation, 500);
            }
        }

        function saveReviewerData() {
            localStorage.setItem('talentEvaluationData', JSON.stringify(reviewerData));
        }

        function saveEmployeeEvaluation() {
            // Don't save while loading employee data
            if (window.loadingEmployeeData) return;
            
            if (!currentReviewer || !currentEmployee) return;
            
            const employee = reviewerData[currentReviewer].employees[currentEmployee];
            if (!employee) return;
            
            const previousStatus = employee.status;
            const previousData = employee.evaluationData || {};
            
            // Save current form data - reviewer name is always from logged-in user
            const evaluationData = {
                employeeName: document.getElementById('employeeName')?.value || employee.name,
                reviewerName: reviewerData[currentReviewer].name, // Always use logged-in reviewer name
                reviewPeriod: document.getElementById('reviewPeriod')?.value || 'FY26',
                overallRating: document.querySelector('.rating-btn.selected')?.getAttribute('data-rating') || 'successful',
                keyPriorities: document.getElementById('keyPriorities')?.value || '',
                resultsImpact: document.getElementById('resultsImpact')?.value || '',
                collaboration: document.getElementById('collaboration')?.value || '',
                growth: document.getElementById('growth')?.value || '',
                lookingAhead: document.getElementById('lookingAhead')?.value || ''
            };
            
            // Check if data has changed from previously completed evaluation
            const dataChanged = previousStatus === 'completed' && (
                previousData.employeeName !== evaluationData.employeeName ||
                previousData.reviewPeriod !== evaluationData.reviewPeriod ||
                previousData.overallRating !== evaluationData.overallRating ||
                previousData.keyPriorities !== evaluationData.keyPriorities ||
                previousData.resultsImpact !== evaluationData.resultsImpact ||
                previousData.collaboration !== evaluationData.collaboration ||
                previousData.growth !== evaluationData.growth ||
                previousData.lookingAhead !== evaluationData.lookingAhead
            );
            
            console.log('SaveEmployeeEvaluation debug:');
            console.log('previousStatus:', previousStatus);
            console.log('previousData.overallRating:', previousData.overallRating);
            console.log('evaluationData.overallRating:', evaluationData.overallRating);
            console.log('dataChanged:', dataChanged);
            
            // Update employee data
            employee.evaluationData = evaluationData;
            employee.lastUpdated = new Date().toISOString();
            
            // Update status based on completion and changes
            const completedFields = Object.values(evaluationData).filter(val => val && val.trim()).length;
            
            if (dataChanged) {
                // If completed evaluation was modified, change to in-progress
                employee.status = 'in-progress';
                employee.statusChangeReason = 'Modified after completion';
            } else if (employee.status !== 'completed' && completedFields > 2) {
                // Only auto-set to in-progress, never auto-complete
                employee.status = 'in-progress';
            }
            // Note: Status only goes to 'completed' via Complete Evaluation button
            
            saveReviewerData();
            
            // Update status display in the evaluation form header
            updateStatusDisplay();
            
            // Auto-regenerate comprehensive summary if on that step
            if (currentStep === 6) {
                setTimeout(() => {
                    generateComprehensiveSummary();
                }, 200);
            }
        }

        function updateStatusDisplay() {
            const employee = reviewerData[currentReviewer]?.employees[currentEmployee];
            if (!employee) return;

            // Update the status indicator in the evaluation form header
            const statusElement = document.querySelector('.employee-info p span[class^="status-"]');
            if (statusElement) {
                // Remove old status class
                statusElement.className = statusElement.className.replace(/status-\S+/g, '');
                // Add new status class
                statusElement.classList.add(`status-${employee.status}`);
                // Update status text
                statusElement.textContent = employee.status.replace('-', ' ').toUpperCase();
            }

            // Also update the sidebar employee list status (for when returning to dashboard)
            updateSidebarEmployeeStatus(employee);
        }

        function updateSidebarEmployeeStatus(employee) {
            // This will update the status when the user returns to the dashboard
            // The actual visual update happens when loadReviewerDashboard() is called
            // But we can also update it immediately if the sidebar exists
            
            const employeeItems = document.querySelectorAll('.employee-item');
            employeeItems.forEach(item => {
                if (item.getAttribute('onclick')?.includes(currentEmployee)) {
                    // Update the status class on the employee item
                    item.className = `employee-item ${employee.status}`;
                    
                    // Update the status text and icon
                    const statusElement = item.querySelector('.employee-status');
                    if (statusElement) {
                        statusElement.className = `employee-status status-${employee.status}`;
                        statusElement.textContent = employee.status === 'completed' ? '✓ Complete' : 
                                                 employee.status === 'in-progress' ? '⏱ In Progress' : '○ Not Started';
                    }
                }
            });
        }

        function logoutReviewer() {
            currentReviewer = null;
            currentEmployee = null;
            
            // Remove reviewer param from URL
            const newUrl = new URL(window.location);
            newUrl.searchParams.delete('reviewer');
            window.history.pushState({}, '', newUrl);
            
            showReviewerLogin();
        }

        function getEvaluationFormContent(employee) {
            const evalData = employee.evaluationData || {};
            
            return `
                <!-- Step 0: Basic Information -->
                <div class="slide active" id="slide-0">
                    <p class="description">Enter basic information and select the overall performance rating</p>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="employeeName">Employee Name:</label>
                            <input type="text" id="employeeName" placeholder="Enter employee name" value="${evalData.employeeName || employee.name}">
                        </div>
                        <div class="form-group">
                            <label for="reviewerName">Reviewer Name: <small style="color: #28a745; font-weight: normal;">(Auto-populated)</small></label>
                            <input type="text" id="reviewerName" placeholder="Enter reviewer name" value="${reviewerData[currentReviewer].name}" readonly>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="reviewPeriod">Fiscal Year:</label>
                        <select id="reviewPeriod">
                            <option value="FY26" ${evalData.reviewPeriod === 'FY26' ? 'selected' : ''}>FY26</option>
                            <option value="FY25" ${evalData.reviewPeriod === 'FY25' ? 'selected' : ''}>FY25</option>
                            <option value="FY24" ${evalData.reviewPeriod === 'FY24' ? 'selected' : ''}>FY24</option>
                            <option value="FY23" ${evalData.reviewPeriod === 'FY23' ? 'selected' : ''}>FY23</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Overall Performance Rating:</label>
                        <div class="rating-buttons">
                            <div class="rating-btn ${evalData.overallRating === 'exemplary' ? 'selected' : ''}" onclick="selectRating(this, 'exemplary')" data-rating="exemplary">
                                <strong>Exemplary</strong>
                                <small>Performance consistently exceeds the requirements of the role</small>
                            </div>
                            <div class="rating-btn ${evalData.overallRating === 'successful' || !evalData.overallRating ? 'selected' : ''}" onclick="selectRating(this, 'successful')" data-rating="successful">
                                <strong>Successful</strong>
                                <small>Performance consistently meets the requirements of the role</small>
                            </div>
                            <div class="rating-btn ${evalData.overallRating === 'opportunity' ? 'selected' : ''}" onclick="selectRating(this, 'opportunity')" data-rating="opportunity">
                                <strong>Opportunity</strong>
                                <small>Performance consistently failed to meet the requirements of the role</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Key Priorities -->
                <div class="slide" id="slide-1">
                    <p class="description">What were the associate's main goals or deliverables this year?</p>

                    <div class="suggestions">
                        <h4>Smart Content Suggestions</h4>
                        <div class="suggestion-item" onclick="addSuggestion('keyPriorities', 'Successfully delivered on key business priorities including...')">
                            "Successfully delivered on key business priorities including..."
                        </div>
                        <div class="suggestion-item" onclick="addSuggestion('keyPriorities', 'Exceeded expectations by achieving...')">
                            "Exceeded expectations by achieving..."
                        </div>
                        <div class="suggestion-item" onclick="addSuggestion('keyPriorities', 'Consistently focused on strategic objectives such as...')">
                            "Consistently focused on strategic objectives such as..."
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="keyPriorities">Feedback:</label>
                        <textarea id="keyPriorities" rows="6" placeholder="Provide specific, objective feedback with examples and measurable outcomes..." onkeyup="analyzeFeedback('keyPriorities')">${evalData.keyPriorities || ''}</textarea>
                    </div>

                    <!-- AI Writing Coach -->
                    <div class="writing-coach" id="coach-keyPriorities" style="display: none;">
                        <div class="coach-header">
                            <span style="font-size: 20px;">🤖</span>
                            <h4>AI Writing Coach</h4>
                        </div>
                        <div class="metrics-grid">
                            <div class="metric" id="objectivity-keyPriorities">
                                <span class="metric-value">0%</span>
                                <div class="metric-label">Objectivity</div>
                            </div>
                            <div class="metric" id="specificity-keyPriorities">
                                <span class="metric-value">0%</span>
                                <div class="metric-label">Specificity</div>
                            </div>
                            <div class="metric" id="completeness-keyPriorities">
                                <span class="metric-value">0%</span>
                                <div class="metric-label">Completeness</div>
                            </div>
                        </div>
                        <div class="bias-alerts" id="alerts-keyPriorities"></div>
                    </div>
                </div>

                <!-- Step 2: Results & Impact -->
                <div class="slide" id="slide-2">
                    <p class="description">What outcomes did they drive, and how did they move the business or brand forward?</p>

                    <div class="suggestions">
                        <h4>Smart Content Suggestions</h4>
                        <div class="suggestion-item" onclick="addSuggestion('resultsImpact', 'Delivered measurable business impact by achieving...')">
                            "Delivered measurable business impact by achieving..."
                        </div>
                        <div class="suggestion-item" onclick="addSuggestion('resultsImpact', 'Generated significant value through...')">
                            "Generated significant value through..."
                        </div>
                        <div class="suggestion-item" onclick="addSuggestion('resultsImpact', 'Improved key metrics including...')">
                            "Improved key metrics including..."
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="resultsImpact">Feedback:</label>
                        <textarea id="resultsImpact" rows="6" placeholder="Provide specific, objective feedback with examples and measurable outcomes..." onkeyup="analyzeFeedback('resultsImpact')">${evalData.resultsImpact || ''}</textarea>
                    </div>

                    <!-- AI Writing Coach -->
                    <div class="writing-coach" id="coach-resultsImpact" style="display: none;">
                        <div class="coach-header">
                            <span style="font-size: 20px;">🤖</span>
                            <h4>AI Writing Coach</h4>
                        </div>
                        <div class="metrics-grid">
                            <div class="metric" id="objectivity-resultsImpact">
                                <span class="metric-value">0%</span>
                                <div class="metric-label">Objectivity</div>
                            </div>
                            <div class="metric" id="specificity-resultsImpact">
                                <span class="metric-value">0%</span>
                                <div class="metric-label">Specificity</div>
                            </div>
                            <div class="metric" id="completeness-resultsImpact">
                                <span class="metric-value">0%</span>
                                <div class="metric-label">Completeness</div>
                            </div>
                        </div>
                        <div class="bias-alerts" id="alerts-resultsImpact"></div>
                    </div>
                </div>

                <!-- Step 3: Collaboration -->
                <div class="slide" id="slide-3">
                    <p class="description">How did they partner across teams or functions to deliver results?</p>

                    <div class="suggestions">
                        <h4>Smart Content Suggestions</h4>
                        <div class="suggestion-item" onclick="addSuggestion('collaboration', 'Built strong partnerships with cross-functional teams to...')">
                            "Built strong partnerships with cross-functional teams to..."
                        </div>
                        <div class="suggestion-item" onclick="addSuggestion('collaboration', 'Influenced positive outcomes by effectively communicating...')">
                            "Influenced positive outcomes by effectively communicating..."
                        </div>
                        <div class="suggestion-item" onclick="addSuggestion('collaboration', 'Demonstrated leadership by facilitating...')">
                            "Demonstrated leadership by facilitating..."
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="collaboration">Feedback:</label>
                        <textarea id="collaboration" rows="6" placeholder="Provide specific, objective feedback with examples and measurable outcomes..." onkeyup="analyzeFeedback('collaboration')">${evalData.collaboration || ''}</textarea>
                    </div>

                    <!-- AI Writing Coach -->
                    <div class="writing-coach" id="coach-collaboration" style="display: none;">
                        <div class="coach-header">
                            <span style="font-size: 20px;">🤖</span>
                            <h4>AI Writing Coach</h4>
                        </div>
                        <div class="metrics-grid">
                            <div class="metric" id="objectivity-collaboration">
                                <span class="metric-value">0%</span>
                                <div class="metric-label">Objectivity</div>
                            </div>
                            <div class="metric" id="specificity-collaboration">
                                <span class="metric-value">0%</span>
                                <div class="metric-label">Specificity</div>
                            </div>
                            <div class="metric" id="completeness-collaboration">
                                <span class="metric-value">0%</span>
                                <div class="metric-label">Completeness</div>
                            </div>
                        </div>
                        <div class="bias-alerts" id="alerts-collaboration"></div>
                    </div>
                </div>

                <!-- Step 4: Growth & Development -->
                <div class="slide" id="slide-4">
                    <p class="description">What new skills, behaviors, or leadership qualities did they build this year?</p>

                    <div class="suggestions">
                        <h4>Smart Content Suggestions</h4>
                        <div class="suggestion-item" onclick="addSuggestion('growth', 'Developed new capabilities in...')">
                            "Developed new capabilities in..."
                        </div>
                        <div class="suggestion-item" onclick="addSuggestion('growth', 'Showed significant growth by learning...')">
                            "Showed significant growth by learning..."
                        </div>
                        <div class="suggestion-item" onclick="addSuggestion('growth', 'Strengthened leadership skills through...')">
                            "Strengthened leadership skills through..."
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="growth">Feedback:</label>
                        <textarea id="growth" rows="6" placeholder="Provide specific, objective feedback with examples and measurable outcomes..." onkeyup="analyzeFeedback('growth')">${evalData.growth || ''}</textarea>
                    </div>

                    <!-- AI Writing Coach -->
                    <div class="writing-coach" id="coach-growth" style="display: none;">
                        <div class="coach-header">
                            <span style="font-size: 20px;">🤖</span>
                            <h4>AI Writing Coach</h4>
                        </div>
                        <div class="metrics-grid">
                            <div class="metric" id="objectivity-growth">
                                <span class="metric-value">0%</span>
                                <div class="metric-label">Objectivity</div>
                            </div>
                            <div class="metric" id="specificity-growth">
                                <span class="metric-value">0%</span>
                                <div class="metric-label">Specificity</div>
                            </div>
                            <div class="metric" id="completeness-growth">
                                <span class="metric-value">0%</span>
                                <div class="metric-label">Completeness</div>
                            </div>
                        </div>
                        <div class="bias-alerts" id="alerts-growth"></div>
                    </div>
                </div>

                <!-- Step 5: Looking Ahead -->
                <div class="slide" id="slide-5">
                    <p class="description">What are their biggest opportunities and development areas to grow next year?</p>

                    <div class="suggestions">
                        <h4>Smart Content Suggestions</h4>
                        <div class="suggestion-item" onclick="addSuggestion('lookingAhead', 'Key development opportunities include...')">
                            "Key development opportunities include..."
                        </div>
                        <div class="suggestion-item" onclick="addSuggestion('lookingAhead', 'Focus areas for next year should be...')">
                            "Focus areas for next year should be..."
                        </div>
                        <div class="suggestion-item" onclick="addSuggestion('lookingAhead', 'Recommended stretch assignments or experiences...')">
                            "Recommended stretch assignments or experiences..."
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="lookingAhead">Feedback:</label>
                        <textarea id="lookingAhead" rows="6" placeholder="Provide specific, objective feedback with examples and measurable outcomes..." onkeyup="analyzeFeedback('lookingAhead')">${evalData.lookingAhead || ''}</textarea>
                    </div>

                    <!-- AI Writing Coach -->
                    <div class="writing-coach" id="coach-lookingAhead" style="display: none;">
                        <div class="coach-header">
                            <span style="font-size: 20px;">🤖</span>
                            <h4>AI Writing Coach</h4>
                        </div>
                        <div class="metrics-grid">
                            <div class="metric" id="objectivity-lookingAhead">
                                <span class="metric-value">0%</span>
                                <div class="metric-label">Objectivity</div>
                            </div>
                            <div class="metric" id="specificity-lookingAhead">
                                <span class="metric-value">0%</span>
                                <div class="metric-label">Specificity</div>
                            </div>
                            <div class="metric" id="completeness-lookingAhead">
                                <span class="metric-value">0%</span>
                                <div class="metric-label">Completeness</div>
                            </div>
                        </div>
                        <div class="bias-alerts" id="alerts-lookingAhead"></div>
                    </div>
                </div>

                <!-- Step 6: Comprehensive Summary -->
                <div class="slide" id="slide-6">
                    <p class="description">Auto-generated comprehensive narrative for calibration meetings and performance discussions</p>

                    <div class="summary-container">
                        <div class="form-group">
                            <label for="comprehensiveSummary">Performance Summary for Calibration:</label>
                            <textarea id="comprehensiveSummary" rows="15" placeholder="Summary will be automatically generated when you navigate to this step..." readonly class="summary-textarea"></textarea>
                        </div>

                        <div class="summary-actions-simple">
                            <button class="btn btn-primary" onclick="copySummaryToClipboard()">Copy to Clipboard</button>
                            <button class="btn btn-outline" onclick="downloadSummaryAsPDF()">Download PDF</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadEmployeeData(employee) {
            const evalData = employee.evaluationData || {};
            
            // Temporarily disable auto-advancement while loading
            window.loadingEmployeeData = true;
            autoAdvancementInProgress = false; // Reset auto-advancement flag
            
            // Populate form fields with employee's actual data
            setTimeout(() => {
                // Basic Information
                const employeeNameField = document.getElementById('employeeName');
                const reviewerNameField = document.getElementById('reviewerName');
                const reviewPeriodField = document.getElementById('reviewPeriod');
                const overallRatingField = document.getElementById('overallRating');
                
                if (employeeNameField) {
                    employeeNameField.value = evalData.employeeName || employee.name || '';
                }
                if (reviewerNameField) {
                    reviewerNameField.value = evalData.reviewerName || currentReviewer || '';
                }
                if (reviewPeriodField) {
                    reviewPeriodField.value = evalData.reviewPeriod || '';
                }
                if (overallRatingField) {
                    overallRatingField.value = evalData.overallRating || '';
                }
                
                // Text areas
                const textFields = ['keyPriorities', 'resultsImpact', 'collaboration', 'growth', 'lookingAhead'];
                textFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = evalData[fieldId] || '';
                        // Trigger analysis for existing content
                        if (field.value.trim()) {
                            analyzeFeedback(fieldId);
                        }
                    }
                });
                
                // Re-enable auto-advancement after loading is complete
                setTimeout(() => {
                    window.loadingEmployeeData = false;
                    console.log('Employee data loading complete - auto-advancement re-enabled');
                    
                    // Initialize undo/redo for text fields
                    if (typeof setupUndoRedoForTextFields !== 'undefined') {
                        setupUndoRedoForTextFields();
                    }
                }, 800);
            }, 100);
        }

        function addNewEmployee() {
            const employeeName = prompt('Enter employee name:');
            const employeePosition = prompt('Enter employee position:');
            
            if (!employeeName || !employeePosition) {
                alert('Please provide both name and position');
                return;
            }
            
            const employeeId = 'emp' + Date.now();
            const newEmployee = {
                id: employeeId,
                name: employeeName.trim(),
                position: employeePosition.trim(),
                status: 'not-started',
                evaluationData: {},
                lastUpdated: new Date().toISOString()
            };
            
            reviewerData[currentReviewer].employees[employeeId] = newEmployee;
            saveReviewerData();
            
            // Refresh the dashboard
            loadReviewerDashboard();
        }

        function deleteEmployee(employeeId, event) {
            // Stop event propagation to prevent starting evaluation
            event.stopPropagation();
            
            const employee = reviewerData[currentReviewer]?.employees[employeeId];
            if (!employee) return;
            
            // Confirm deletion
            const confirmDelete = confirm(
                `Are you sure you want to remove ${employee.name} from your team?\n\n` +
                `This will permanently delete their evaluation data and cannot be undone.`
            );
            
            if (!confirmDelete) return;
            
            // Delete the employee
            delete reviewerData[currentReviewer].employees[employeeId];
            saveReviewerData();
            
            // If we're currently editing this employee, return to dashboard
            if (currentEmployee === employeeId) {
                currentEmployee = null;
                loadReviewerDashboard();
                return;
            }
            
            // Refresh the dashboard to show updated list
            loadReviewerDashboard();
        }

        function archiveEmployee(employeeId, event) {
            // Stop event propagation to prevent starting evaluation
            event.stopPropagation();
            
            const employee = reviewerData[currentReviewer]?.employees[employeeId];
            if (!employee) return;
            
            // Confirm archiving
            const confirmArchive = confirm(
                `Archive ${employee.name}?\n\n` +
                `This will move them to archived team members. Their evaluation data will be preserved and they can be restored later if needed.`
            );
            
            if (!confirmArchive) return;
            
            // Archive the employee
            employee.archived = true;
            employee.archivedDate = new Date().toISOString();
            saveReviewerData();
            
            // If we're currently editing this employee, return to dashboard
            if (currentEmployee === employeeId) {
                currentEmployee = null;
                loadReviewerDashboard();
                return;
            }
            
            // Refresh the dashboard to show updated list
            loadReviewerDashboard();
        }

        function restoreEmployee(employeeId, event) {
            // Stop event propagation to prevent starting evaluation
            event.stopPropagation();
            
            const employee = reviewerData[currentReviewer]?.employees[employeeId];
            if (!employee) return;
            
            // Confirm restoration
            const confirmRestore = confirm(
                `Restore ${employee.name} to your active team?`
            );
            
            if (!confirmRestore) return;
            
            // Restore the employee
            delete employee.archived;
            delete employee.archivedDate;
            saveReviewerData();
            
            // Refresh the dashboard to show updated list
            loadReviewerDashboard();
        }

        // Drag-and-Drop Employee Reordering
        let currentSortMode = localStorage.getItem('employeeSortMode') || 'alphabetical';
        let customEmployeeOrder = JSON.parse(localStorage.getItem('customEmployeeOrder') || '{}');
        let draggedElement = null;

        function getSortedEmployees(employees) {
            const reviewerOrder = customEmployeeOrder[currentReviewer] || [];
            
            switch(currentSortMode) {
                case 'alphabetical':
                    return employees.sort((a, b) => {
                        const lastNameA = a.name.split(' ').pop().toLowerCase();
                        const lastNameB = b.name.split(' ').pop().toLowerCase();
                        return lastNameA.localeCompare(lastNameB);
                    });
                    
                case 'status':
                    const statusOrder = { 'in-progress': 1, 'not-started': 2, 'completed': 3 };
                    return employees.sort((a, b) => {
                        const statusDiff = statusOrder[a.status] - statusOrder[b.status];
                        if (statusDiff !== 0) return statusDiff;
                        // Secondary sort by name
                        return a.name.localeCompare(b.name);
                    });
                    
                case 'custom':
                    if (reviewerOrder.length === 0) {
                        // If no custom order exists, fall back to alphabetical
                        return employees.sort((a, b) => a.name.localeCompare(b.name));
                    }
                    return employees.sort((a, b) => {
                        const indexA = reviewerOrder.indexOf(a.id);
                        const indexB = reviewerOrder.indexOf(b.id);
                        
                        // If both items are in custom order
                        if (indexA !== -1 && indexB !== -1) {
                            return indexA - indexB;
                        }
                        // If only A is in custom order, it comes first
                        if (indexA !== -1) return -1;
                        // If only B is in custom order, it comes first
                        if (indexB !== -1) return 1;
                        // Neither in custom order, sort alphabetically
                        return a.name.localeCompare(b.name);
                    });
                    
                default:
                    return employees;
            }
        }

        function setSortMode(mode) {
            currentSortMode = mode;
            localStorage.setItem('employeeSortMode', mode);
            
            // Update active button
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`sort-${mode}`).classList.add('active');
            
            // Refresh the dashboard to apply new sorting
            loadReviewerDashboard();
        }

        function handleDragStart(event) {
            draggedElement = event.target;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.outerHTML);
            
            // Automatically switch to custom sort mode when dragging starts
            if (currentSortMode !== 'custom') {
                setSortMode('custom');
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const target = event.target.closest('.employee-item');
            if (target && target !== draggedElement) {
                target.classList.add('drag-over');
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            const target = event.target.closest('.employee-item');
            
            if (target && draggedElement && target !== draggedElement) {
                const container = target.parentNode;
                const draggedId = draggedElement.dataset.employeeId;
                const targetId = target.dataset.employeeId;
                
                // Get current order of all employee items
                const allItems = Array.from(container.children);
                const newOrder = [];
                
                // Create new order array
                allItems.forEach(item => {
                    if (item === draggedElement) return; // Skip dragged element
                    
                    if (item === target) {
                        // Insert dragged element before target
                        newOrder.push(draggedId);
                    }
                    newOrder.push(item.dataset.employeeId);
                });
                
                // If dragged to the end, add it at the end
                if (!newOrder.includes(draggedId)) {
                    newOrder.push(draggedId);
                }
                
                // Save custom order
                if (!customEmployeeOrder[currentReviewer]) {
                    customEmployeeOrder[currentReviewer] = [];
                }
                customEmployeeOrder[currentReviewer] = newOrder;
                localStorage.setItem('customEmployeeOrder', JSON.stringify(customEmployeeOrder));
                
                // Refresh dashboard to show new order
                loadReviewerDashboard();
            }
            
            // Clean up drag states
            document.querySelectorAll('.employee-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            document.querySelectorAll('.employee-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedElement = null;
        }

        // Undo/Redo Functionality
        let actionHistory = [];
        let historyIndex = -1;
        const MAX_HISTORY_SIZE = 50;

        function recordAction(action) {
            // Remove any actions after current index (when user has undone some actions)
            actionHistory = actionHistory.slice(0, historyIndex + 1);
            
            // Add new action
            actionHistory.push({
                ...action,
                timestamp: Date.now()
            });
            
            // Limit history size
            if (actionHistory.length > MAX_HISTORY_SIZE) {
                actionHistory = actionHistory.slice(-MAX_HISTORY_SIZE);
            }
            
            historyIndex = actionHistory.length - 1;
            updateUndoRedoUI();
        }

        function undo() {
            if (historyIndex >= 0) {
                const action = actionHistory[historyIndex];
                executeUndoAction(action);
                historyIndex--;
                updateUndoRedoUI();
                showUndoRedoNotification('Undo', action.description);
            }
        }

        function redo() {
            if (historyIndex < actionHistory.length - 1) {
                historyIndex++;
                const action = actionHistory[historyIndex];
                executeRedoAction(action);
                updateUndoRedoUI();
                showUndoRedoNotification('Redo', action.description);
            }
        }

        function executeUndoAction(action) {
            const employee = reviewerData[currentReviewer]?.employees[currentEmployee];
            if (!employee) return;
            
            switch(action.type) {
                case 'text_change':
                    const field = document.getElementById(action.fieldId);
                    if (field) {
                        field.value = action.oldValue;
                        // Re-trigger analysis if we're in evaluation mode
                        if (typeof analyzeFeedback === 'function') {
                            analyzeFeedback(action.fieldId);
                        }
                    }
                    // Update stored data
                    if (employee.evaluationData) {
                        employee.evaluationData[action.fieldId] = action.oldValue;
                    }
                    break;
                    
                case 'rating_change':
                    const ratingBtns = document.querySelectorAll('.rating-btn');
                    ratingBtns.forEach(btn => {
                        btn.classList.remove('selected');
                        if (btn.dataset.rating === action.oldRating) {
                            btn.classList.add('selected');
                        }
                    });
                    if (employee.evaluationData) {
                        employee.evaluationData.overallRating = action.oldRating;
                    }
                    break;
                    
                case 'step_navigation':
                    goToStep(action.oldStep);
                    break;
            }
            
            // Auto-save the changes
            setTimeout(saveEmployeeEvaluation, 100);
        }

        function executeRedoAction(action) {
            const employee = reviewerData[currentReviewer]?.employees[currentEmployee];
            if (!employee) return;
            
            switch(action.type) {
                case 'text_change':
                    const field = document.getElementById(action.fieldId);
                    if (field) {
                        field.value = action.newValue;
                        if (typeof analyzeFeedback === 'function') {
                            analyzeFeedback(action.fieldId);
                        }
                    }
                    if (employee.evaluationData) {
                        employee.evaluationData[action.fieldId] = action.newValue;
                    }
                    break;
                    
                case 'rating_change':
                    const ratingBtns = document.querySelectorAll('.rating-btn');
                    ratingBtns.forEach(btn => {
                        btn.classList.remove('selected');
                        if (btn.dataset.rating === action.newRating) {
                            btn.classList.add('selected');
                        }
                    });
                    if (employee.evaluationData) {
                        employee.evaluationData.overallRating = action.newRating;
                    }
                    break;
                    
                case 'step_navigation':
                    goToStep(action.newStep);
                    break;
            }
            
            // Auto-save the changes
            setTimeout(saveEmployeeEvaluation, 100);
        }

        function updateUndoRedoUI() {
            // Update undo button if it exists
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            if (undoBtn) {
                undoBtn.disabled = historyIndex < 0;
                undoBtn.title = historyIndex >= 0 ? 
                    `Undo: ${actionHistory[historyIndex]?.description || 'Last action'}` : 
                    'Nothing to undo';
            }
            
            if (redoBtn) {
                redoBtn.disabled = historyIndex >= actionHistory.length - 1;
                redoBtn.title = historyIndex < actionHistory.length - 1 ? 
                    `Redo: ${actionHistory[historyIndex + 1]?.description || 'Next action'}` : 
                    'Nothing to redo';
            }
        }

        function showUndoRedoNotification(type, description) {
            const notification = document.createElement('div');
            notification.className = 'undo-redo-notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">${type === 'Undo' ? '↶' : '↷'}</span>
                    <span class="notification-text">${type}: ${description}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => notification.classList.add('show'), 10);
            
            // Remove after 2 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Enhanced text change tracking for undo/redo
        function setupUndoRedoForTextFields() {
            const textFields = document.querySelectorAll('input, textarea, select');
            
            textFields.forEach(field => {
                let oldValue = field.value;
                let changeTimeout;
                
                // Track changes with debouncing
                field.addEventListener('input', function(event) {
                    const newValue = field.value;
                    
                    // Clear previous timeout
                    clearTimeout(changeTimeout);
                    
                    // Set new timeout to record action after user stops typing
                    changeTimeout = setTimeout(() => {
                        if (oldValue !== newValue) {
                            recordAction({
                                type: 'text_change',
                                fieldId: field.id,
                                oldValue: oldValue,
                                newValue: newValue,
                                description: `Edit ${field.labels?.[0]?.textContent || field.id || 'field'}`
                            });
                            oldValue = newValue;
                        }
                    }, 1000); // 1 second delay after user stops typing
                });
                
                // Also record on blur (when user leaves the field)
                field.addEventListener('blur', function() {
                    clearTimeout(changeTimeout);
                    const newValue = field.value;
                    if (oldValue !== newValue) {
                        recordAction({
                            type: 'text_change',
                            fieldId: field.id,
                            oldValue: oldValue,
                            newValue: newValue,
                            description: `Edit ${field.labels?.[0]?.textContent || field.id || 'field'}`
                        });
                        oldValue = newValue;
                    }
                });
            });
        }

        // Keyboard shortcuts for undo/redo
        document.addEventListener('keydown', function(event) {
            // Only work in evaluation mode
            if (!currentEmployee) return;
            
            if ((event.ctrlKey || event.metaKey) && !event.shiftKey && event.key === 'z') {
                event.preventDefault();
                undo();
            } else if (((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'Z') || 
                       ((event.ctrlKey || event.metaKey) && event.key === 'y')) {
                event.preventDefault();
                redo();
            }
        });

        // Dropdown-related functions
        let selectedEmployeeId = null;

        function handleEmployeeSelection(employeeId) {
            selectedEmployeeId = employeeId;
            const actionsPanel = document.getElementById('employee-actions-panel');
            
            if (employeeId) {
                const employee = reviewerData[currentReviewer]?.employees[employeeId];
                if (employee) {
                    actionsPanel.style.display = 'block';
                    
                    // Update download functionality based on employee data
                    const hasEvalData = employee.evaluationData && Object.keys(employee.evaluationData).length > 0;
                    const downloadBtn = actionsPanel.querySelector('.smart-action-item:nth-child(2)'); // Download PDF item
                    if (downloadBtn) {
                        downloadBtn.style.opacity = hasEvalData ? '1' : '0.5';
                        downloadBtn.style.pointerEvents = hasEvalData ? 'auto' : 'none';
                    }
                }
            } else {
                actionsPanel.style.display = 'none';
            }
        }

        function startSelectedEmployeeEvaluation() {
            if (selectedEmployeeId) {
                startEvaluation(selectedEmployeeId);
            }
        }

        // Search Functions
        function filterEmployees() {
            const searchInput = document.getElementById('employeeSearch');
            const searchTerm = searchInput?.value.toLowerCase() || '';
            const dropdown = document.getElementById('employeeDropdown');
            const clearBtn = document.querySelector('.clear-search');
            
            if (!dropdown) return;
            
            // Show/hide clear button
            if (clearBtn) {
                clearBtn.style.display = searchTerm ? 'flex' : 'none';
            }
            
            const options = dropdown.querySelectorAll('option');
            let visibleCount = 0;
            
            options.forEach((option, index) => {
                if (index === 0) { // Skip the placeholder option
                    option.style.display = 'block';
                    return;
                }
                
                const name = option.getAttribute('data-name') || '';
                const matchesSearch = !searchTerm || name.includes(searchTerm);
                
                option.style.display = matchesSearch ? 'block' : 'none';
                if (matchesSearch) visibleCount++;
            });

            // Update the first option to show count only if searching
            if (options[0]) {
                if (searchTerm) {
                    options[0].textContent = visibleCount > 0 ? `Select an employee... (${visibleCount} found)` : 'No employees found';
                } else {
                    options[0].textContent = 'Select an employee...';
                }
            }
        }

        function clearSearch() {
            const searchInput = document.getElementById('employeeSearch');
            if (searchInput) {
                searchInput.value = '';
                filterEmployees();
                searchInput.focus();
            }
        }







        function downloadSelectedEmployeePDF() {
            if (selectedEmployeeId) {
                const employee = reviewerData[currentReviewer]?.employees[selectedEmployeeId];
                if (employee && employee.evaluationData && Object.keys(employee.evaluationData).length > 0) {
                    downloadIndividualEvaluationPDF(selectedEmployeeId);
                }
            }
        }

        function archiveSelectedEmployee() {
            if (selectedEmployeeId) {
                archiveEmployee(selectedEmployeeId, { stopPropagation: () => {} });
                selectedEmployeeId = null;
                document.getElementById('employee-actions-panel').style.display = 'none';
                document.querySelector('.employee-dropdown').value = '';
            }
        }

        function deleteSelectedEmployee() {
            if (selectedEmployeeId) {
                deleteEmployee(selectedEmployeeId, { stopPropagation: () => {} });
                selectedEmployeeId = null;
                document.getElementById('employee-actions-panel').style.display = 'none';
                document.querySelector('.employee-dropdown').value = '';
            }
        }

        function toggleArchivedEmployees() {
            const archivedList = document.getElementById('archived-list');
            const toggle = document.getElementById('archived-toggle');
            
            if (archivedList.style.display === 'none') {
                archivedList.style.display = 'block';
                toggle.innerHTML = '<span>▲ Hide Archived</span>';
            } else {
                archivedList.style.display = 'none';
                toggle.innerHTML = '<span>▼ Show Archived</span>';
            }
        }

        function viewTeamReport() {
            const reviewer = reviewerData[currentReviewer];
            const employees = Object.values(reviewer.employees || {});
            const activeEmployees = employees.filter(emp => !emp.archived);
            
            if (activeEmployees.length === 0) {
                alert('No active employees to report on.');
                return;
            }
            
            // Calculate analytics
            const totalEmployees = activeEmployees.length;
            const completedEvaluations = activeEmployees.filter(emp => emp.status === 'completed').length;
            const inProgressEvaluations = activeEmployees.filter(emp => emp.status === 'in-progress').length;
            const notStartedEvaluations = activeEmployees.filter(emp => emp.status === 'not-started').length;
            
            // Rating distribution (only count employees with actual ratings)
            const ratingsCount = { exemplary: 0, successful: 0, opportunity: 0, 'not-set': 0 };
            const employeesWithRatings = activeEmployees.filter(emp => emp.status === 'completed' && emp.evaluationData?.overallRating);
            const employeesWithoutRatings = activeEmployees.filter(emp => !emp.evaluationData?.overallRating || emp.status !== 'completed');
            
            employeesWithRatings.forEach(emp => {
                const rating = emp.evaluationData.overallRating;
                if (ratingsCount[rating] !== undefined) {
                    ratingsCount[rating]++;
                }
            });
            
            // Count employees without ratings separately
            ratingsCount['not-set'] = employeesWithoutRatings.length;
            
            // Recent activity
            const recentActivity = activeEmployees
                .filter(emp => emp.lastUpdated)
                .sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated))
                .slice(0, 10);
            
            const reportHTML = `
                <div class="team-report-overlay" onclick="closeTeamReport(event)">
                    <div class="team-report-modal" onclick="event.stopPropagation()">
                        <div class="report-header">
                            <h2>Team Performance Report</h2>
                            <p>Reviewer: ${reviewer.name} | ${new Date().toLocaleDateString()}</p>
                            <button class="close-btn" onclick="closeTeamReport()">&times;</button>
                        </div>
                        
                        <div class="report-content">
                            <div class="report-section">
                                <h3>Team Overview</h3>
                                <div class="metrics-grid">
                                    <div class="metric-card">
                                        <div class="metric-number">${totalEmployees}</div>
                                        <div class="metric-label">Total Team Members</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-number">${completedEvaluations}</div>
                                        <div class="metric-label">Completed Evaluations</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-number">${inProgressEvaluations}</div>
                                        <div class="metric-label">In Progress</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-number">${notStartedEvaluations}</div>
                                        <div class="metric-label">Not Started</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="report-section">
                                <h3>Overall Rating Distribution</h3>
                                <div class="rating-distribution">
                                    <div class="rating-bar">
                                        <div class="rating-label">Exemplary</div>
                                        <div class="rating-progress">
                                            <div class="rating-fill exemplary" style="width: ${totalEmployees > 0 ? (ratingsCount.exemplary / totalEmployees) * 100 : 0}%"></div>
                                        </div>
                                        <div class="rating-count">${ratingsCount.exemplary}</div>
                                    </div>
                                    <div class="rating-bar">
                                        <div class="rating-label">Successful</div>
                                        <div class="rating-progress">
                                            <div class="rating-fill successful" style="width: ${totalEmployees > 0 ? (ratingsCount.successful / totalEmployees) * 100 : 0}%"></div>
                                        </div>
                                        <div class="rating-count">${ratingsCount.successful}</div>
                                    </div>
                                    <div class="rating-bar">
                                        <div class="rating-label">Opportunity</div>
                                        <div class="rating-progress">
                                            <div class="rating-fill opportunity" style="width: ${totalEmployees > 0 ? (ratingsCount.opportunity / totalEmployees) * 100 : 0}%"></div>
                                        </div>
                                        <div class="rating-count">${ratingsCount.opportunity}</div>
                                    </div>
                                    <div class="rating-bar">
                                        <div class="rating-label">Not Rated</div>
                                        <div class="rating-progress">
                                            <div class="rating-fill not-rated" style="width: ${totalEmployees > 0 ? (ratingsCount['not-set'] / totalEmployees) * 100 : 0}%"></div>
                                        </div>
                                        <div class="rating-count">${ratingsCount['not-set']}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="report-section">
                                <h3>Team Member Status</h3>
                                <div class="employee-status-list">
                                    ${activeEmployees.map(emp => `
                                        <div class="employee-status-item">
                                            <div class="employee-info">
                                                <div class="employee-name">${emp.name}</div>
                                            </div>
                                            <div class="status-info">
                                                <div class="status-badge ${emp.status}">${emp.status.replace('-', ' ').toUpperCase()}</div>
                                                <div class="rating-badge ${emp.evaluationData?.overallRating || 'not-set'}">${emp.evaluationData?.overallRating || 'Not Rated'}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="report-actions">
                                <button class="btn btn-primary" onclick="downloadTeamReport()">Download Report</button>
                                <button class="btn btn-outline" onclick="exportEvaluations()">Export All (PDF)</button>
                                <button class="btn btn-outline" onclick="closeTeamReport()">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', reportHTML);
        }
        
        function closeTeamReport(event) {
            if (event && event.target !== event.currentTarget) return;
            const overlay = document.querySelector('.team-report-overlay');
            if (overlay) {
                overlay.remove();
            }
        }
        
        function downloadTeamReport() {
            const reviewer = reviewerData[currentReviewer];
            const employees = Object.values(reviewer.employees || {}).filter(emp => !emp.archived);
            
            // Create PDF using jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Set up the document
            let yPos = 20;
            const pageWidth = doc.internal.pageSize.width;
            const marginX = 20;
            const contentWidth = pageWidth - (marginX * 2);
            
            // Header with logo space
            doc.setFillColor(0, 67, 160);
            doc.rect(0, 0, pageWidth, 35, 'F');
            
            // Title
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('TEAM PERFORMANCE REPORT', marginX, 25);
            
            // Report info
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            yPos = 50;
            
            doc.text(`Reviewer: ${reviewer.name.replace(/[^\x00-\x7F]/g, '')}`, marginX, yPos);
            yPos += 8;
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, marginX, yPos);
            yPos += 8;
            doc.text(`Total Team Members: ${employees.length}`, marginX, yPos);
            yPos += 15;
            
            // Evaluation Status Section
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('EVALUATION STATUS SUMMARY', marginX, yPos);
            yPos += 10;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            
            const completedCount = employees.filter(emp => emp.status === 'completed').length;
            const inProgressCount = employees.filter(emp => emp.status === 'in-progress').length;
            const notStartedCount = employees.filter(emp => emp.status === 'not-started').length;
            
            doc.text(`• Completed Evaluations: ${completedCount}`, marginX + 10, yPos);
            yPos += 7;
            doc.text(`• In Progress: ${inProgressCount}`, marginX + 10, yPos);
            yPos += 7;
            doc.text(`• Not Started: ${notStartedCount}`, marginX + 10, yPos);
            yPos += 15;
            
            // Rating Distribution (only count employees with actual ratings)
            const ratingsCount = { exemplary: 0, successful: 0, opportunity: 0, 'not-rated': 0 };
            const employeesWithRatings = employees.filter(emp => emp.status === 'completed' && emp.evaluationData?.overallRating);
            const employeesWithoutRatings = employees.filter(emp => !emp.evaluationData?.overallRating || emp.status !== 'completed');
            
            employeesWithRatings.forEach(emp => {
                const rating = emp.evaluationData.overallRating;
                if (ratingsCount[rating] !== undefined) {
                    ratingsCount[rating]++;
                }
            });
            
            // Count employees without ratings separately
            ratingsCount['not-rated'] = employeesWithoutRatings.length;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('PERFORMANCE RATING DISTRIBUTION', marginX, yPos);
            yPos += 10;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`• Exemplary: ${ratingsCount.exemplary}`, marginX + 10, yPos);
            yPos += 7;
            doc.text(`• Successful: ${ratingsCount.successful}`, marginX + 10, yPos);
            yPos += 7;
            doc.text(`• Opportunity: ${ratingsCount.opportunity}`, marginX + 10, yPos);
            yPos += 7;
            doc.text(`• Not Rated: ${ratingsCount['not-rated']}`, marginX + 10, yPos);
            yPos += 20;
            
            // Team Members Table
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('TEAM MEMBERS DETAILS', marginX, yPos);
            yPos += 10;
            
            // Table header
            doc.setFillColor(240, 240, 240);
            doc.rect(marginX, yPos - 5, contentWidth, 12, 'F');
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Name', marginX + 5, yPos + 3);
            doc.text('Position', marginX + 60, yPos + 3);
            doc.text('Status', marginX + 120, yPos + 3);
            doc.text('Rating', marginX + 155, yPos + 3);
            yPos += 12;
            
            // Table rows
            doc.setFont(undefined, 'normal');
            employees.forEach((emp, index) => {
                // Check if we need a new page
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // Alternating row colors
                if (index % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(marginX, yPos - 3, contentWidth, 10, 'F');
                }
                
                const rating = emp.evaluationData?.overallRating || 'Not Rated';
                const status = emp.status.charAt(0).toUpperCase() + emp.status.slice(1).replace('-', ' ');
                
                doc.setTextColor(0, 0, 0);
                doc.text(emp.name.replace(/[^\x00-\x7F]/g, '').substring(0, 22), marginX + 5, yPos + 3);
                doc.text(emp.position.replace(/[^\x00-\x7F]/g, '').substring(0, 18), marginX + 60, yPos + 3);
                
                // Status with color coding
                if (emp.status === 'completed') doc.setTextColor(40, 167, 69);
                else if (emp.status === 'in-progress') doc.setTextColor(0, 175, 215);
                else doc.setTextColor(108, 117, 125);
                
                doc.text(status, marginX + 120, yPos + 3);
                
                // Rating with color coding
                if (rating === 'exemplary') doc.setTextColor(40, 167, 69);
                else if (rating === 'successful') doc.setTextColor(0, 175, 215);
                else if (rating === 'opportunity') doc.setTextColor(255, 193, 7);
                else doc.setTextColor(108, 117, 125);
                
                doc.text(rating.charAt(0).toUpperCase() + rating.slice(1), marginX + 155, yPos + 3);
                doc.setTextColor(0, 0, 0);
                
                yPos += 10;
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Sam's Club Talent Evaluation Dashboard - Page ${i} of ${pageCount}`, marginX, doc.internal.pageSize.height - 10);
                doc.text(`Generated: ${new Date().toLocaleString()}`, pageWidth - 80, doc.internal.pageSize.height - 10);
            }
            
            // Download the PDF
            const fileName = `${reviewer.name.replace(/\s+/g, '_')}_Team_Report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        // Analytics & Insights Function
        function showAnalyticsInsights() {
            const reviewer = reviewerData[currentReviewer];
            const employees = Object.values(reviewer.employees || {});
            const activeEmployees = employees.filter(emp => !emp.archived);
            
            if (activeEmployees.length === 0) {
                alert('No evaluation data available for analysis. Please complete some evaluations first.');
                return;
            }
            
            const insights = generateInsights(activeEmployees);
            
            const analyticsHTML = `
                <div class="team-report-overlay" onclick="closeAnalytics(event)">
                    <div class="team-report-modal" onclick="event.stopPropagation()" style="max-width: 1200px;">
                        <div class="report-header">
                            <h2>📊 Analytics & Insights Dashboard</h2>
                            <p>AI-Powered Analysis for ${reviewer.name}'s Team | ${activeEmployees.length} Team Members</p>
                            <button class="close-btn" onclick="closeAnalytics()">&times;</button>
                        </div>
                        
                        <div class="analytics-container">
                            <!-- Performance Patterns -->
                            <div class="insights-section">
                                <h3>🎯 Performance Patterns</h3>
                                <div class="pattern-grid">
                                    ${insights.performancePatterns.map(pattern => `
                                        <div class="pattern-card ${pattern.type}">
                                            <div class="pattern-title">${pattern.title}</div>
                                            <div class="pattern-description">${pattern.description}</div>
                                            <div class="pattern-data">${pattern.data}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Rating Distribution -->
                            <div class="insights-section">
                                <h3>📈 Rating Distribution Analysis</h3>
                                <div class="rating-distribution">
                                    ${Object.entries(insights.ratingDistribution).map(([rating, data]) => `
                                        <div class="rating-bar">
                                            <div class="rating-bar-fill ${rating}" style="height: ${Math.max(20, data.percentage)}px;">
                                                ${data.count}
                                            </div>
                                            <div>${rating.charAt(0).toUpperCase() + rating.slice(1)}</div>
                                            <div>${data.percentage}%</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <p><strong>Insight:</strong> ${insights.ratingInsight}</p>
                            </div>
                            
                            <!-- Bias Detection Heatmap -->
                            <div class="insights-section">
                                <h3>⚠️ Bias Detection Analysis</h3>
                                <div class="bias-heatmap">
                                    ${insights.biasAnalysis.map(bias => `
                                        <div class="bias-indicator ${bias.level}">
                                            <div><strong>${bias.type}</strong></div>
                                            <div>Risk: ${bias.level.toUpperCase()}</div>
                                            <div>${bias.count} instances</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <p><strong>Overall Bias Score:</strong> ${insights.overallBiasScore}/100 (Lower is better)</p>
                            </div>
                            
                            <!-- Content Quality Trends -->
                            <div class="insights-section">
                                <h3>📝 Content Quality Trends</h3>
                                <div class="pattern-grid">
                                    <div class="pattern-card">
                                        <div class="pattern-title">Average Objectivity</div>
                                        <div class="pattern-description">Across all evaluation sections</div>
                                        <div class="pattern-data">
                                            <span class="insight-metric">${insights.contentQuality.avgObjectivity}%</span>
                                            ${insights.contentQuality.objectivityTrend}
                                        </div>
                                    </div>
                                    <div class="pattern-card">
                                        <div class="pattern-title">Average Specificity</div>
                                        <div class="pattern-description">Detail level in evaluations</div>
                                        <div class="pattern-data">
                                            <span class="insight-metric">${insights.contentQuality.avgSpecificity}%</span>
                                            ${insights.contentQuality.specificityTrend}
                                        </div>
                                    </div>
                                    <div class="pattern-card">
                                        <div class="pattern-title">Completion Rate</div>
                                        <div class="pattern-description">Fully completed sections</div>
                                        <div class="pattern-data">
                                            <span class="insight-metric">${insights.contentQuality.completionRate}%</span>
                                            ${insights.contentQuality.completionTrend}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI Recommendations -->
                            <div class="insights-section">
                                <h3>🤖 AI Recommendations</h3>
                                <ul class="recommendations-list">
                                    ${insights.recommendations.map(rec => `
                                        <li>
                                            <div class="recommendation-icon">${rec.priority}</div>
                                            <div>
                                                <strong>${rec.title}</strong><br>
                                                ${rec.description}
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', analyticsHTML);
        }
        
        function closeAnalytics(event) {
            if (event && event.target !== event.currentTarget) return;
            const overlay = document.querySelector('.team-report-overlay');
            if (overlay) {
                overlay.remove();
            }
        }
        
        function generateInsights(employees) {
            const completedEmployees = employees.filter(emp => emp.status === 'completed' && emp.evaluationData);
            
            // Rating Distribution Analysis (consistent with Team Report)
            const ratingDistribution = { 
                exemplary: {count: 0, percentage: 0}, 
                successful: {count: 0, percentage: 0}, 
                opportunity: {count: 0, percentage: 0}
            };
            
            // Only count employees with actual ratings (completed evaluations)
            const employeesWithRatings = employees.filter(emp => emp.status === 'completed' && emp.evaluationData?.overallRating);
            
            employeesWithRatings.forEach(emp => {
                const rating = emp.evaluationData.overallRating;
                if (rating && ratingDistribution[rating]) {
                    ratingDistribution[rating].count++;
                }
            });
            
            // Calculate percentages based on employees with ratings (not total employees)
            const totalWithRatings = employeesWithRatings.length || 1;
            Object.keys(ratingDistribution).forEach(rating => {
                ratingDistribution[rating].percentage = Math.round((ratingDistribution[rating].count / totalWithRatings) * 100);
            });
            
            // Performance Patterns Detection
            const performancePatterns = [];
            
            // High Performers Pattern
            const highPerformers = completedEmployees.filter(emp => emp.evaluationData?.overallRating === 'exemplary');
            if (highPerformers.length > 0) {
                performancePatterns.push({
                    type: 'info',
                    title: 'High Performers Identified',
                    description: `${highPerformers.length} team members rated as Exemplary`,
                    data: `Names: ${highPerformers.map(emp => emp.name).join(', ')}`
                });
            }
            
            // Improvement Opportunities
            const improvementCases = completedEmployees.filter(emp => emp.evaluationData?.overallRating === 'opportunity');
            if (improvementCases.length > 0) {
                performancePatterns.push({
                    type: 'warning',
                    title: 'Development Opportunities',
                    description: `${improvementCases.length} team members need focused development`,
                    data: `Consider additional training and mentoring support`
                });
            }
            
            // Completion Pattern
            const completionRate = Math.round((completedEmployees.length / employees.length) * 100);
            performancePatterns.push({
                type: completionRate < 50 ? 'alert' : 'info',
                title: 'Evaluation Progress',
                description: `${completionRate}% of evaluations completed`,
                data: `${completedEmployees.length} of ${employees.length} evaluations finished`
            });
            
            // Bias Analysis
            const biasAnalysis = analyzeBiasPatterns(completedEmployees);
            
            // Content Quality Analysis
            const contentQuality = analyzeContentQuality(completedEmployees);
            
            // AI Recommendations
            const recommendations = generateRecommendations(employees, ratingDistribution, biasAnalysis, contentQuality);
            
            // Rating Distribution Insight
            let ratingInsight = '';
            if (ratingDistribution.exemplary.percentage > 50) {
                ratingInsight = 'High concentration of top performers - consider stretch assignments and leadership development.';
            } else if (ratingDistribution.opportunity.percentage > 30) {
                ratingInsight = 'Significant development needs identified - focus on targeted improvement plans.';
            } else {
                ratingInsight = 'Balanced performance distribution across the team.';
            }
            
            return {
                performancePatterns,
                ratingDistribution,
                ratingInsight,
                biasAnalysis,
                contentQuality,
                recommendations,
                overallBiasScore: Math.round(biasAnalysis.reduce((sum, bias) => sum + bias.score, 0) / biasAnalysis.length)
            };
        }
        
        function analyzeBiasPatterns(employees) {
            const biasTypes = {
                'Length Bias': 0,
                'Recency Bias': 0,
                'Subjective Language': 0,
                'Generic Feedback': 0
            };
            
            employees.forEach(emp => {
                if (!emp.evaluationData) return;
                
                // Analyze each section for bias patterns
                ['keyPriorities', 'resultsImpact', 'collaboration', 'growth', 'lookingAhead'].forEach(section => {
                    const content = emp.evaluationData[section];
                    if (!content) return;
                    
                    // Length bias (too short/long)
                    if (content.length < 50 || content.length > 1000) biasTypes['Length Bias']++;
                    
                    // Subjective language
                    const subjectiveWords = ['good', 'bad', 'great', 'poor', 'nice', 'awesome', 'terrible', 'amazing'];
                    if (subjectiveWords.some(word => content.toLowerCase().includes(word))) {
                        biasTypes['Subjective Language']++;
                    }
                    
                    // Generic feedback
                    const genericPhrases = ['did well', 'good job', 'met expectations', 'performed as expected'];
                    if (genericPhrases.some(phrase => content.toLowerCase().includes(phrase))) {
                        biasTypes['Generic Feedback']++;
                    }
                });
            });
            
            return Object.entries(biasTypes).map(([type, count]) => ({
                type,
                count,
                level: count > 5 ? 'high' : count > 2 ? 'medium' : 'low',
                score: count * 10
            }));
        }
        
        function analyzeContentQuality(employees) {
            let totalObjectivity = 0, totalSpecificity = 0, totalSections = 0;
            let completedSections = 0;
            
            employees.forEach(emp => {
                if (!emp.evaluationData) return;
                
                ['keyPriorities', 'resultsImpact', 'collaboration', 'growth', 'lookingAhead'].forEach(section => {
                    const content = emp.evaluationData[section];
                    totalSections++;
                    
                    if (content && content.length > 20) {
                        completedSections++;
                        
                        // Simulate objectivity/specificity calculation
                        const objectivity = calculateObjectivity(content, section);
                        const specificity = calculateSpecificity(content, section);
                        
                        totalObjectivity += objectivity;
                        totalSpecificity += specificity;
                    }
                });
            });
            
            const avgObjectivity = Math.round(totalObjectivity / (completedSections || 1));
            const avgSpecificity = Math.round(totalSpecificity / (completedSections || 1));
            const completionRate = Math.round((completedSections / totalSections) * 100);
            
            return {
                avgObjectivity,
                avgSpecificity,
                completionRate,
                objectivityTrend: avgObjectivity > 70 ? '📈 Excellent' : avgObjectivity > 50 ? '📊 Good' : '📉 Needs Improvement',
                specificityTrend: avgSpecificity > 70 ? '📈 Detailed' : avgSpecificity > 50 ? '📊 Adequate' : '📉 Too Generic',
                completionTrend: completionRate > 80 ? '✅ Complete' : completionRate > 60 ? '⚠️ Partial' : '❌ Incomplete'
            };
        }
        
        function generateRecommendations(employees, ratingDistribution, biasAnalysis, contentQuality) {
            const recommendations = [];
            
            // Based on completion rate
            const completionRate = Math.round((employees.filter(emp => emp.status === 'completed').length / employees.length) * 100);
            if (completionRate < 70) {
                recommendations.push({
                    priority: '1',
                    title: 'Complete Remaining Evaluations',
                    description: `${100 - completionRate}% of evaluations are still incomplete. Set a deadline to finish all assessments.`
                });
            }
            
            // Based on bias analysis
            const highBiasCount = biasAnalysis.filter(bias => bias.level === 'high').length;
            if (highBiasCount > 0) {
                recommendations.push({
                    priority: '2',
                    title: 'Address Evaluation Bias',
                    description: 'High bias detected in multiple areas. Review feedback for objectivity and add specific examples with measurable outcomes.'
                });
            }
            
            // Based on content quality
            if (contentQuality.avgObjectivity < 60) {
                recommendations.push({
                    priority: '3',
                    title: 'Improve Objectivity',
                    description: 'Add more factual, measurable examples in evaluations. Replace subjective opinions with concrete achievements and data.'
                });
            }
            
            if (contentQuality.avgSpecificity < 60) {
                recommendations.push({
                    priority: '4',
                    title: 'Increase Specificity',
                    description: 'Include more detailed examples, dates, numbers, and specific project names in your evaluations.'
                });
            }
            
            // Based on rating distribution
            if (ratingDistribution.exemplary.percentage > 70) {
                recommendations.push({
                    priority: '5',
                    title: 'Challenge High Performers',
                    description: 'Consider stretch assignments, leadership roles, or cross-functional projects for your top performers.'
                });
            }
            
            if (ratingDistribution.opportunity.percentage > 20) {
                recommendations.push({
                    priority: '6',
                    title: 'Development Planning',
                    description: 'Create detailed improvement plans with specific goals, timelines, and support resources for team members needing development.'
                });
            }
            
            return recommendations;
        }

        // Individual Evaluation Download Function

        function downloadIndividualEvaluationPDF(employeeId, event) {
            if (event) {
                event.stopPropagation(); // Prevent triggering startEvaluation
            }
            
            const reviewer = reviewerData[currentReviewer];
            const employee = reviewer.employees[employeeId];
            
            if (!employee || !employee.evaluationData || Object.keys(employee.evaluationData).length === 0) {
                alert('No evaluation data available for this employee.');
                return;
            }

            const data = employee.evaluationData;
            const currentDate = new Date().toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
            
            // Initialize jsPDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('portrait', 'mm', 'a4');
            
            // Page dimensions and settings
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 12;
            const contentWidth = pageWidth - (2 * margin);
            let y = margin;
            
            // Helper function for consistent spacing
            function addSpace(amount = 5) {
                y += amount;
                if (y > pageHeight - 20) {
                    pdf.addPage();
                    y = margin;
                }
            }
            
            // Helper function to add wrapped text
            function addText(text, fontSize = 10, style = 'normal', color = [0, 0, 0], indent = 0) {
                pdf.setFontSize(fontSize);
                pdf.setFont(undefined, style);
                pdf.setTextColor(...color);
                
                const lines = pdf.splitTextToSize(text, contentWidth - indent);
                const textHeight = lines.length * (fontSize * 0.35);
                
                // Check if we need a new page
                if (y + textHeight > pageHeight - 15) {
                    pdf.addPage();
                    y = margin;
                }
                
                pdf.text(lines, margin + indent, y);
                y += textHeight + 2;
                
                // Reset color
                pdf.setTextColor(0, 0, 0);
                return y;
            }
            
            // Header
            addText('PERFORMANCE SUMMARY FOR CALIBRATION', 16, 'bold');
            addText('Confidential - Manager Use Only', 10, 'normal', [100, 100, 100]);
            addSpace(8);
            
            // Employee info - clean without box
            addText(employee.name, 14, 'bold');
            addText(`${data.reviewPeriod || 'FY26'}`, 9, 'normal', [80, 80, 80]);
            
            // Rating - clean display
            const rating = data.overallRating ? data.overallRating.toUpperCase() : 'PENDING';
            let ratingColor = [128, 128, 128]; // Default gray
            
            if (data.overallRating === 'exemplary') {
                ratingColor = [0, 120, 0];
            } else if (data.overallRating === 'successful') {
                ratingColor = [0, 80, 160];
            } else if (data.overallRating === 'opportunity') {
                ratingColor = [180, 0, 0];
            }
            
            addText(`Current Rating: ${rating}`, 11, 'bold', ratingColor);
            addSpace(8);
            
            // Performance areas
            addText('PERFORMANCE SUMMARY', 12, 'bold');
            addSpace(3);
            
            const areas = [
                { label: 'Key Priorities', content: data.keyPriorities },
                { label: 'Results & Impact', content: data.resultsImpact },
                { label: 'Collaboration', content: data.collaboration },
                { label: 'Growth & Development', content: data.growth },
                { label: 'Development Focus', content: data.lookingAhead }
            ];
            
            areas.forEach(area => {
                if (area.content && area.content.trim()) {
                    // Section header
                    addText(`${area.label}:`, 10, 'bold', [0, 80, 160]);
                    
                    // Content - keep it concise for calibration
                    let content = area.content.trim();
                    if (content.length > 180) {
                        content = content.substring(0, 180) + '...';
                    }
                    
                    addText(content, 9, 'normal', [40, 40, 40], 3);
                    addSpace(3);
                }
            });
            
            // Calibration section
            addSpace(5);
            addText('CALIBRATION DISCUSSION', 12, 'bold');
            addSpace(3);
            
            // Notes area
            addText('Discussion Notes:', 10, 'bold');
            const notesStartY = y;
            for (let i = 0; i < 5; i++) {
                pdf.setDrawColor(200, 200, 200);
                pdf.line(margin, y, margin + contentWidth, y);
                addSpace(6);
            }
            
            // Final Rating Calibration
            addSpace(3);
            addText('Final Rating Calibration:', 10, 'bold');
            addSpace(2);
            
            // Create lines for writing the final rating
            pdf.setDrawColor(150, 150, 150);
            pdf.line(margin, y, margin + 80, y);
            
            addSpace(12);
            
            // Footer
            y = pageHeight - 8;
            pdf.setFontSize(7);
            pdf.setTextColor(120, 120, 120);
            pdf.text(`Generated: ${currentDate}`, margin, y);
            pdf.text('Sam\'s Club - CONFIDENTIAL', pageWidth - margin, y, { align: 'right' });
            
            // Save the PDF
            pdf.save(`${employee.name.replace(/\s+/g, '_')}_Calibration_Summary_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportEvaluations() {
            const reviewer = reviewerData[currentReviewer];
            const employees = Object.values(reviewer.employees || {}).filter(emp => !emp.archived);
            
            if (employees.length === 0) {
                alert('No evaluations to export.');
                return;
            }
            
            // Create PDF using jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            const pageWidth = doc.internal.pageSize.width;
            const marginX = 20;
            
            // Header
            doc.setFillColor(0, 67, 160);
            doc.rect(0, 0, pageWidth, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('ALL TEAM EVALUATIONS EXPORT', marginX, 25);
            
            // Report info
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            yPos = 50;
            
            doc.text(`Reviewer: ${reviewer.name.replace(/[^\x00-\x7F]/g, '')}`, marginX, yPos);
            yPos += 8;
            doc.text(`Export Date: ${new Date().toLocaleDateString()}`, marginX, yPos);
            yPos += 8;
            doc.text(`Total Evaluations: ${employees.length}`, marginX, yPos);
            yPos += 20;
            
            // Process each employee
            employees.forEach((employee, index) => {
                // Check if we need a new page
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // Employee header
                doc.setFillColor(240, 248, 255);
                doc.rect(marginX - 5, yPos - 8, pageWidth - (marginX * 2) + 10, 20, 'F');
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 67, 160);
                doc.text(`${index + 1}. ${employee.name.replace(/[^\x00-\x7F]/g, '')}`, marginX, yPos);
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                doc.text(`Position: ${employee.position.replace(/[^\x00-\x7F]/g, '')}`, marginX, yPos + 8);
                
                // Status and rating
                const status = employee.status.charAt(0).toUpperCase() + employee.status.slice(1).replace('-', ' ');
                const rating = employee.evaluationData?.overallRating || 'Not Rated';
                doc.text(`Status: ${status} | Rating: ${rating.charAt(0).toUpperCase() + rating.slice(1)}`, marginX + 100, yPos + 8);
                
                yPos += 25;
                
                // Evaluation details if completed
                if (employee.evaluationData && employee.status === 'completed') {
                    const sections = [
                        { key: 'keyPriorities', title: 'Key Priorities' },
                        { key: 'resultsImpact', title: 'Results & Impact' },
                        { key: 'collaboration', title: 'Collaboration & Influence' },
                        { key: 'growth', title: 'Growth & Development' },
                        { key: 'lookingAhead', title: 'Looking Ahead' }
                    ];
                    
                    sections.forEach(section => {
                        const content = employee.evaluationData[section.key];
                        if (content && content.trim()) {
                            // Check page break
                            if (yPos > 260) {
                                doc.addPage();
                                yPos = 20;
                            }
                            
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            doc.text(`${section.title}:`, marginX + 5, yPos);
                            yPos += 6;
                            
                            doc.setFont(undefined, 'normal');
                            
                            // Clean content to remove problematic characters for PDF
                            const cleanContent = content.replace(/[^\x00-\x7F]/g, ''); // Remove non-ASCII characters
                            
                            // Split long text into multiple lines
                            const lines = doc.splitTextToSize(cleanContent, pageWidth - marginX - 30);
                            lines.forEach(line => {
                                if (yPos > 280) {
                                    doc.addPage();
                                    yPos = 20;
                                }
                                doc.text(line, marginX + 10, yPos);
                                yPos += 5;
                            });
                            yPos += 3;
                        }
                    });
                } else if (employee.status === 'in-progress') {
                    doc.setFontSize(10);
                    doc.setTextColor(255, 193, 7);
                    doc.text('WARNING: Evaluation in progress - partial data only', marginX + 5, yPos);
                    yPos += 8;
                    doc.setTextColor(0, 0, 0);
                } else {
                    doc.setFontSize(10);
                    doc.setTextColor(220, 53, 69);
                    doc.text('INCOMPLETE: Evaluation not started', marginX + 5, yPos);
                    yPos += 8;
                    doc.setTextColor(0, 0, 0);
                }
                
                yPos += 15;
            });
            
            // Footer on all pages
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Sam's Club Talent Evaluation Dashboard - All Evaluations Export`, marginX, doc.internal.pageSize.height - 15);
                doc.text(`Page ${i} of ${pageCount}`, pageWidth - 40, doc.internal.pageSize.height - 15);
                doc.text(`Generated: ${new Date().toLocaleString()}`, marginX, doc.internal.pageSize.height - 8);
            }
            
            // Download the PDF
            const fileName = `${reviewer.name.replace(/\s+/g, '_')}_All_Evaluations_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        // Intelligent Navigation System with Auto-save
        function setupAutoSave() {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', (event) => {
                    // Don't process input events while loading employee data
                    if (window.loadingEmployeeData) return;
                    
                    const employee = reviewerData[currentReviewer]?.employees[currentEmployee];
                    
                    // Direct status change for completed evaluations
                    if (employee && employee.status === 'completed') {
                        // DIRECTLY change status to in-progress
                        employee.status = 'in-progress';
                        employee.statusChangeReason = `Modified ${event.target.id || 'evaluation field'}`;
                        employee.lastUpdated = new Date().toISOString();
                        
                        // Save immediately
                        saveReviewerData();
                        
                        // Update status display
                        updateStatusDisplay();
                        
                        // Auto-regenerate comprehensive summary if on that step
                        if (currentStep === 6) {
                            setTimeout(() => {
                                generateComprehensiveSummary();
                            }, 200);
                        }
                        
                        // Show notification
                        showStatusChangeNotification(event.target.id || 'Field', 'Completed', 'In Progress');
                        
                        console.log(`Status changed from completed to in-progress due to field modification: ${event.target.id}`);
                    }
                    
                    // Auto-save after short delay
                    setTimeout(saveEmployeeEvaluation, 300);
                });

                // Also save on blur (when user finishes with a field)
                input.addEventListener('blur', (event) => {
                    // Don't process blur events while loading employee data
                    if (window.loadingEmployeeData) return;
                    
                    // Just save the data, no auto-advancement
                    setTimeout(saveEmployeeEvaluation, 300);
                });
            });
        }

        // Backend logic to check step completion (auto-advancement disabled)
        function checkForAutoAdvancement(triggerElement) {
            // Auto-advancement is disabled - users must click "Next" button
            // This function now only performs validation and saves data
            
            if (window.loadingEmployeeData) return;
            if (!triggerElement || !currentEmployee || !reviewerData[currentReviewer]) return;

            const employee = reviewerData[currentReviewer].employees[currentEmployee];
            if (!employee || !employee.evaluationData) return;

            const data = employee.evaluationData;
            const stepComplete = checkCurrentStepCompletion(data);

            // Only log completion status, no auto-advancement
            if (stepComplete) {
                console.log(`Step ${currentStep + 1} is complete. User must click "Next" to proceed.`);
                
                // Optional: Show a subtle indicator that the step is ready to advance
                const nextBtn = document.getElementById('nextBtn');
                if (nextBtn && !nextBtn.classList.contains('step-ready')) {
                    nextBtn.classList.add('step-ready');
                    nextBtn.style.backgroundColor = '#00AFD7';
                    nextBtn.style.transform = 'scale(1.02)';
                }
            }
        }

        // Check if current step has sufficient content to advance
        function checkCurrentStepCompletion(data) {
            switch (currentStep) {
                case 0: // Basic Information & Rating
                    return data.employeeName && 
                           data.reviewerName && 
                           data.overallRating && 
                           data.overallRating !== '';

                case 1: // Key Priorities
                    return data.keyPriorities && 
                           data.keyPriorities.trim().length > 50;

                case 2: // Results & Impact
                    return data.resultsImpact && 
                           data.resultsImpact.trim().length > 50;

                case 3: // Collaboration & Influence
                    return data.collaboration && 
                           data.collaboration.trim().length > 50;

                case 4: // Growth & Development
                    return data.growth && 
                           data.growth.trim().length > 50;

                case 5: // Looking Ahead
                    return data.lookingAhead && 
                           data.lookingAhead.trim().length > 50;

                case 6: // Comprehensive Summary (final step)
                    return false; // Don't auto-advance from final step

                default:
                    return false;
            }
        }

        // Show subtle notification when automatically progressing
        function showStepProgressNotification(fromStep, toStep) {
            const stepNames = [
                'Basic Information & Rating',
                'Key Priorities', 
                'Results & Impact',
                'Collaboration & Influence',
                'Growth & Development',
                'Looking Ahead',
                'Comprehensive Summary'
            ];

            // Remove any existing progress notification
            const existing = document.querySelector('.step-progress-notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = 'step-progress-notification';
            notification.innerHTML = `
                <div class="progress-notification-content">
                    <div class="progress-icon">→</div>
                    <div class="progress-text">
                        <div class="progress-title">Auto-advancing</div>
                        <div class="progress-subtitle">Moving to: ${stepNames[toStep]}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        function showStatusChangeNotification(fieldName = '', fromStatus = '', toStatus = '') {
            // Remove any existing notification
            const existingNotification = document.querySelector('.status-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Create notification message
            let message;
            if (fieldName && fromStatus && toStatus) {
                message = `${fieldName} changed: Status updated from "${fromStatus}" to "${toStatus}"`;
            } else {
                message = 'Status changed to "In Progress" due to modifications';
            }

            // Create and show notification
            const notification = document.createElement('div');
            notification.className = 'status-notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">⚠️</span>
                    <span class="notification-text">${message}</span>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function generateComprehensiveSummary() {
            const employee = reviewerData[currentReviewer]?.employees[currentEmployee];
            if (!employee) return;

            const evalData = employee.evaluationData || {};
            const includeMetrics = document.getElementById('includeMetrics')?.checked;
            const includeDevelopment = document.getElementById('includeDevelopment')?.checked;
            const includeStrengths = document.getElementById('includeStrengths')?.checked;

            // Check if evaluation has meaningful content
            const hasContent = {
                keyPriorities: evalData.keyPriorities && evalData.keyPriorities.trim().length > 0,
                resultsImpact: evalData.resultsImpact && evalData.resultsImpact.trim().length > 0,
                collaboration: evalData.collaboration && evalData.collaboration.trim().length > 0,
                growth: evalData.growth && evalData.growth.trim().length > 0,
                lookingAhead: evalData.lookingAhead && evalData.lookingAhead.trim().length > 0,
                overallRating: evalData.overallRating && evalData.overallRating !== ''
            };

            const contentCount = Object.values(hasContent).filter(Boolean).length;

            let summary = `Performance Evaluation Summary: ${evalData.employeeName || employee.name}\n`;
            summary += `Review Period: ${evalData.reviewPeriod || 'Current Period'}\n`;
            summary += `Overall Rating: ${evalData.overallRating ? evalData.overallRating.charAt(0).toUpperCase() + evalData.overallRating.slice(1) : 'Not Set'}\n\n`;

            // If evaluation is mostly empty, show appropriate message
            if (contentCount === 0) {
                summary += `EVALUATION STATUS:\n`;
                summary += `This evaluation has not been started. No performance data has been entered yet.\n\n`;
                summary += `NEXT STEPS:\n`;
                summary += `• Complete the Key Priorities section\n`;
                summary += `• Document Results & Impact with specific examples\n`;
                summary += `• Assess Collaboration & Influence capabilities\n`;
                summary += `• Identify Growth & Development opportunities\n`;
                summary += `• Set Looking Ahead goals and expectations\n`;
                summary += `• Assign an overall performance rating\n\n`;
                summary += `CALIBRATION NOTES:\n`;
                summary += `Evaluation cannot be discussed in calibration meetings until all sections are completed with sufficient detail and supporting evidence.`;
            } else if (contentCount < 3) {
                summary += `EVALUATION STATUS:\n`;
                summary += `This evaluation is in progress but incomplete (${contentCount} of 6 sections completed).\n\n`;
                
                // Show what's completed
                if (hasContent.overallRating) summary += `✓ Overall Rating: ${evalData.overallRating.charAt(0).toUpperCase() + evalData.overallRating.slice(1)}\n`;
                if (hasContent.keyPriorities) summary += `✓ Key Priorities completed\n`;
                if (hasContent.resultsImpact) summary += `✓ Results & Impact completed\n`;
                if (hasContent.collaboration) summary += `✓ Collaboration & Influence completed\n`;
                if (hasContent.growth) summary += `✓ Growth & Development completed\n`;
                if (hasContent.lookingAhead) summary += `✓ Looking Ahead completed\n`;

                summary += `\nREMAINING SECTIONS TO COMPLETE:\n`;
                if (!hasContent.overallRating) summary += `• Overall Performance Rating\n`;
                if (!hasContent.keyPriorities) summary += `• Key Priorities & Objectives\n`;
                if (!hasContent.resultsImpact) summary += `• Results & Business Impact\n`;
                if (!hasContent.collaboration) summary += `• Collaboration & Influence\n`;
                if (!hasContent.growth) summary += `• Growth & Development\n`;
                if (!hasContent.lookingAhead) summary += `• Looking Ahead Goals\n`;

                summary += `\nCALIBRATION READINESS:\n`;
                summary += `Evaluation requires additional completion before being ready for calibration discussions.`;
            } else {
                // Generate full summary for completed/near-complete evaluations
                summary += `EXECUTIVE SUMMARY:\n`;
                if (hasContent.overallRating) {
                    summary += `${evalData.employeeName || employee.name} has demonstrated ${evalData.overallRating === 'exemplary' ? 'exceptional' : evalData.overallRating === 'successful' ? 'solid and consistent' : 'developing'} performance during the ${evalData.reviewPeriod || 'current review period'}. `;
                } else {
                    summary += `${evalData.employeeName || employee.name} performance review is in progress for the ${evalData.reviewPeriod || 'current review period'}. `;
                }
                
                if (hasContent.keyPriorities) {
                    const prioritiesPreview = evalData.keyPriorities.substring(0, 150);
                    summary += `Their focus on key priorities ${prioritiesPreview.includes('achieved') || prioritiesPreview.includes('delivered') ? 'resulted in successful delivery of assigned objectives' : 'has been documented and assessed'}. `;
                }

                if (hasContent.resultsImpact && includeMetrics) {
                    const hasNumbers = /\d+%|\$[\d,]+|\d+\.\d+/.test(evalData.resultsImpact);
                    summary += `${hasNumbers ? 'Measurable business impact was achieved' : 'Business contributions were documented'} across key performance areas. `;
                }
                summary += `\n\n`;

                // Key Priorities Section - only if content exists
                if (hasContent.keyPriorities) {
                    summary += `KEY PRIORITIES & OBJECTIVES:\n`;
                    summary += `${evalData.keyPriorities.trim()}\n\n`;
                }

                // Results & Impact Section - only if content exists
                if (hasContent.resultsImpact) {
                    summary += `RESULTS & BUSINESS IMPACT:\n`;
                    summary += `${evalData.resultsImpact.trim()}\n\n`;
                }

                // Collaboration Section - only if content exists
                if (hasContent.collaboration) {
                    summary += `COLLABORATION & INFLUENCE:\n`;
                    summary += `${evalData.collaboration.trim()}\n\n`;
                }

                // Strengths Section - only if content exists and option is checked
                if (includeStrengths && (hasContent.keyPriorities || hasContent.resultsImpact || hasContent.collaboration || hasContent.growth)) {
                    summary += `KEY STRENGTHS & CAPABILITIES:\n`;
                    const strengths = [];
                    
                    if (hasContent.keyPriorities && (evalData.keyPriorities.includes('exceeded') || evalData.keyPriorities.includes('achieved'))) {
                        strengths.push('Strong execution of strategic priorities');
                    }
                    
                    if (hasContent.resultsImpact && /\d+%|\$[\d,]+/.test(evalData.resultsImpact)) {
                        strengths.push('Delivers measurable business results');
                    }
                    
                    if (hasContent.collaboration && (evalData.collaboration.includes('partner') || evalData.collaboration.includes('team'))) {
                        strengths.push('Effective cross-functional collaboration');
                    }
                    
                    if (hasContent.growth && (evalData.growth.includes('develop') || evalData.growth.includes('learn'))) {
                        strengths.push('Commitment to continuous learning and development');
                    }

                    if (strengths.length > 0) {
                        strengths.forEach(strength => summary += `• ${strength}\n`);
                        summary += `\n`;
                    }
                }

                // Growth & Development Section - only if content exists
                if (hasContent.growth) {
                    summary += `GROWTH & DEVELOPMENT:\n`;
                    summary += `${evalData.growth.trim()}\n\n`;
                }

                // Development Areas Section - only if content exists
                if (includeDevelopment && hasContent.lookingAhead) {
                    summary += `DEVELOPMENT OPPORTUNITIES & NEXT STEPS:\n`;
                    summary += `${evalData.lookingAhead.trim()}\n\n`;
                }

                // Calibration Discussion Points - specific to actual evaluation content
                if (contentCount >= 4) {
                    summary += `CALIBRATION DISCUSSION POINTS:\n`;
                    
                    // Rating justification with specific evidence
                    if (hasContent.overallRating) {
                        summary += `• "${evalData.overallRating.charAt(0).toUpperCase() + evalData.overallRating.slice(1)}" rating is ${hasContent.resultsImpact ? 'supported by measurable business outcomes' : hasContent.keyPriorities ? 'based on documented goal achievement' : 'justified by evaluation evidence'}\n`;
                    }
                    
                    // Key Priorities discussion points
                    if (hasContent.keyPriorities) {
                        const priorities = evalData.keyPriorities.trim();
                        const keyTerms = [];
                        if (priorities.includes('exceeded') || priorities.includes('surpassed')) keyTerms.push('exceeded expectations');
                        if (priorities.includes('achieved') || priorities.includes('completed')) keyTerms.push('achieved objectives');
                        if (priorities.includes('project') || priorities.includes('initiative')) keyTerms.push('project delivery');
                        if (priorities.includes('team') || priorities.includes('leadership')) keyTerms.push('team leadership');
                        if (priorities.includes('strategic') || priorities.includes('strategy')) keyTerms.push('strategic execution');
                        
                        const firstSentence = priorities.split('.')[0].substring(0, 80) + (priorities.length > 80 ? '...' : '');
                        summary += `• Key Priorities evidence: "${firstSentence}"${keyTerms.length > 0 ? ` - demonstrates ${keyTerms.join(', ')}` : ''}\n`;
                    }
                    
                    // Results & Impact discussion points  
                    if (hasContent.resultsImpact) {
                        const results = evalData.resultsImpact.trim();
                        const metrics = results.match(/\d+%|\$[\d,]+|\d+\.\d+|increased|improved|reduced|achieved|delivered/gi) || [];
                        const firstSentence = results.split('.')[0].substring(0, 80) + (results.length > 80 ? '...' : '');
                        summary += `• Business Impact evidence: "${firstSentence}"${metrics.length > 0 ? ` - contains ${metrics.length} measurable outcomes` : ' - qualitative achievements documented'}\n`;
                    }
                    
                    // Collaboration discussion points
                    if (hasContent.collaboration) {
                        const collab = evalData.collaboration.trim();
                        const collabTerms = [];
                        if (collab.includes('cross-functional') || collab.includes('cross functional')) collabTerms.push('cross-functional partnerships');
                        if (collab.includes('stakeholder') || collab.includes('partner')) collabTerms.push('stakeholder management');
                        if (collab.includes('team') || collab.includes('colleague')) collabTerms.push('team collaboration');
                        if (collab.includes('communication') || collab.includes('communicate')) collabTerms.push('communication skills');
                        if (collab.includes('influence') || collab.includes('persuade')) collabTerms.push('influence capabilities');
                        
                        const firstSentence = collab.split('.')[0].substring(0, 80) + (collab.length > 80 ? '...' : '');
                        summary += `• Collaboration evidence: "${firstSentence}"${collabTerms.length > 0 ? ` - highlights ${collabTerms.join(', ')}` : ''}\n`;
                    }
                    
                    // Growth & Development discussion points
                    if (hasContent.growth) {
                        const growth = evalData.growth.trim();
                        const growthTerms = [];
                        if (growth.includes('skill') || growth.includes('competency')) growthTerms.push('skill development');
                        if (growth.includes('learn') || growth.includes('training')) growthTerms.push('learning initiatives');
                        if (growth.includes('feedback') || growth.includes('coaching')) growthTerms.push('feedback integration');
                        if (growth.includes('challenge') || growth.includes('stretch')) growthTerms.push('challenge-seeking');
                        
                        const firstSentence = growth.split('.')[0].substring(0, 80) + (growth.length > 80 ? '...' : '');
                        summary += `• Development evidence: "${firstSentence}"${growthTerms.length > 0 ? ` - shows ${growthTerms.join(', ')}` : ''}\n`;
                    }
                    
                    // Future development discussion points
                    if (hasContent.lookingAhead) {
                        const future = evalData.lookingAhead.trim();
                        const futureTerms = [];
                        if (future.includes('goal') || future.includes('objective')) futureTerms.push('clear goal-setting');
                        if (future.includes('development') || future.includes('grow')) futureTerms.push('development focus');
                        if (future.includes('opportunity') || future.includes('advancement')) futureTerms.push('advancement readiness');
                        if (future.includes('responsibility') || future.includes('role')) futureTerms.push('expanded responsibilities');
                        
                        const firstSentence = future.split('.')[0].substring(0, 80) + (future.length > 80 ? '...' : '');
                        summary += `• Future Development: "${firstSentence}"${futureTerms.length > 0 ? ` - indicates ${futureTerms.join(', ')}` : ''}\n`;
                    }
                    
                    if (hasContent.overallRating) {
                        summary += `• Performance trajectory supports ${evalData.overallRating === 'exemplary' ? 'accelerated development and increased responsibilities' : evalData.overallRating === 'successful' ? 'continued growth in current role with stretch opportunities' : 'focused development plan with clear milestones'}\n\n`;
                    }

                    summary += `RECOMMENDATION:\n`;
                    if (hasContent.overallRating) {
                        if (evalData.overallRating === 'exemplary') {
                            summary += `Strong candidate for advancement opportunities and increased scope of responsibility. Consider for high-visibility projects and leadership development programs.`;
                        } else if (evalData.overallRating === 'successful') {
                            summary += `Solid contributor who consistently meets expectations. Recommend continued development in identified growth areas with appropriate stretch assignments.`;
                        } else {
                            summary += `Focused development plan recommended to address performance gaps and build capabilities for sustained success in role.`;
                        }
                    } else {
                        summary += `Complete overall performance rating to finalize calibration recommendations.`;
                    }
                } else {
                    summary += `CALIBRATION READINESS:\n`;
                    summary += `Additional evaluation completion required before generating calibration discussion points and recommendations.`;
                }
            }



            // Update the textarea
            const summaryTextarea = document.getElementById('comprehensiveSummary');
            if (summaryTextarea) {
                summaryTextarea.value = summary;
                // Update stats
                updateSummaryStats(summary, evalData.overallRating);
            }
        }

        function updateSummaryStats(summary, rating) {
            const wordCount = summary.trim().split(/\s+/).length;
            const readTime = Math.ceil(wordCount / 200); // Average reading speed 200 words/minute

            const wordCountElement = document.getElementById('summaryWordCount');
            const readTimeElement = document.getElementById('summaryReadTime');
            const ratingElement = document.getElementById('summaryRating');

            if (wordCountElement) wordCountElement.textContent = wordCount;
            if (readTimeElement) readTimeElement.textContent = `${readTime} min`;
            if (ratingElement) ratingElement.textContent = rating ? rating.charAt(0).toUpperCase() + rating.slice(1) : 'Not Set';
        }

        function copySummaryToClipboard() {
            const summaryTextarea = document.getElementById('comprehensiveSummary');
            if (summaryTextarea) {
                summaryTextarea.select();
                summaryTextarea.setSelectionRange(0, 99999); // For mobile devices
                
                try {
                    document.execCommand('copy');
                    
                    // Show temporary feedback
                    const copyBtn = document.querySelector('button[onclick="copySummaryToClipboard()"]');
                    if (copyBtn) {
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = 'Copied!';
                        copyBtn.style.background = '#28a745';
                        
                        setTimeout(() => {
                            copyBtn.textContent = originalText;
                            copyBtn.style.background = '';
                        }, 2000);
                    }
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                }
            }
        }

        function downloadSummaryAsPDF() {
            // Use the same PDF format as the individual evaluation download
            if (!currentEmployee) {
                alert('Please select an employee first.');
                return;
            }
            
            // Call the improved downloadIndividualEvaluationPDF function
            downloadIndividualEvaluationPDF(currentEmployee, null);
        }

        // Initialize the system
        document.addEventListener('DOMContentLoaded', function() {
            initializeReviewerSystem();
        });
    </script>
</body>
</html>